/usr/local/lib/python3.11/site-packages/web3/__init__.py:2: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  import pkg_resources
============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-7.4.3, pluggy-1.6.0 -- /usr/local/opt/python@3.11/bin/python3.11
cachedir: .pytest_cache
hypothesis profile 'default' -> database=DirectoryBasedExampleDatabase(PosixPath('/Users/machine/Desktop/Namaskah. app/.hypothesis/examples'))
rootdir: /Users/machine/Desktop/Namaskah. app
configfile: pytest.ini
plugins: hypothesis-6.92.1, cov-4.1.0, asyncio-0.21.1, web3-6.11.3, anyio-3.7.1, langsmith-0.4.49
asyncio: mode=Mode.AUTO
collecting ... collected 1 item

tests/unit/test_notification_service.py::test_cleanup_old_notifications FAILED [100%]

=================================== FAILURES ===================================
________________________ test_cleanup_old_notifications ________________________

notification_service = <app.services.notification_service.NotificationService object at 0x11406c610>
test_user = <app.models.user.User object at 0x113d6a950>
db_session = <sqlalchemy.orm.session.Session object at 0x1138a1e10>

    def test_cleanup_old_notifications(notification_service, test_user, db_session):
        """Test cleaning up old notifications."""
        old_date = datetime.now(timezone.utc) - timedelta(days=40)
        note = Notification(
            user_id=test_user.id,
            type="old",
            title="Old",
            message="Msg",
            created_at=old_date,
            is_read=True
        )
        db_session.add(note)
        db_session.commit()
    
        # Verify it exists
        found = db_session.query(Notification).filter(Notification.id == note.id).first()
        assert found is not None
    
        # Verify filter matches
        cutoff = datetime.now(timezone.utc) - timedelta(days=30)
        # Note: timestamps might slightly differ, but 40 days is << 30 days.
        # In SQLite, date comparison relies on string format if not natively supported.
        # SQLAlchemy handles this usually.
        matched = db_session.query(Notification).filter(Notification.created_at < cutoff).count()
        assert matched >= 1
    
>       count = notification_service.cleanup_old_notifications(days=30)

tests/unit/test_notification_service.py:107: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/services/notification_service.py:295: in cleanup_old_notifications
    count = self.db.query(Notification).filter(Notification.created_at < cutoff_date).delete()
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/query.py:3181: in delete
    result: CursorResult[Any] = self.session.execute(
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/bulk_persistence.py:1946: in orm_execute_statement
    return super().orm_execute_statement(
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/context.py:296: in orm_execute_statement
    return cls.orm_setup_cursor_result(
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/bulk_persistence.py:772: in orm_setup_cursor_result
    cls._do_post_synchronize_evaluate(
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/bulk_persistence.py:1995: in _do_post_synchronize_evaluate
    matched_objects = cls._get_matched_objects_on_criteria(
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/bulk_persistence.py:902: in _get_matched_objects_on_criteria
    evaled_condition = eval_condition(obj)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

obj = <app.models.notification.Notification object at 0x112f40090>

    def evaluate(obj):
        left_val = eval_left(obj)
        right_val = eval_right(obj)
        if left_val is _EXPIRED_OBJECT or right_val is _EXPIRED_OBJECT:
            return _EXPIRED_OBJECT
        elif left_val is None or right_val is None:
            return None
    
>       return operator(eval_left(obj), eval_right(obj))
E       TypeError: can't compare offset-naive and offset-aware datetimes

/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/evaluator.py:263: TypeError
=============================== warnings summary ===============================
app/schemas/kyc.py:23
  /Users/machine/Desktop/Namaskah. app/app/schemas/kyc.py:23: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("date_of_birth")

app/schemas/kyc.py:33
  /Users/machine/Desktop/Namaskah. app/app/schemas/kyc.py:33: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("phone_number")

../../../../usr/local/lib/python3.11/site-packages/_pytest/config/__init__.py:1373
  /usr/local/lib/python3.11/site-packages/_pytest/config/__init__.py:1373: PytestConfigWarning: Unknown config option: env
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/unit/test_notification_service.py::test_cleanup_old_notifications
======================== 1 failed, 3 warnings in 1.16s =========================
