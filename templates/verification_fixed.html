<!DOCTYPE html>
<html lang=\"en\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>SMS Verification - Namaskah</title>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text: #f8fafc;
            --border: #475569;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            line-height: 1.6;
        }
        .navbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
        }
        .navbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .btn-home {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-home:hover { opacity: 0.9; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, var(--primary), #4f46e5);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        .header h1 { font-size: 24px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .balance-widget {
            background: rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 8px;
            text-align: right;
            min-width: 150px;
        }
        .balance-widget .label { font-size: 12px; opacity: 0.8; }
        .balance-widget .amount { font-size: 24px; font-weight: bold; }
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .card h2 { font-size: 20px; margin-bottom: 16px; }
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        .alert.show { display: block; }
        .alert-error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: #fca5a5; }
        .alert-success { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--secondary); color: #86efac; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .search-box, select {
            width: 100%;\n            padding: 12px;\n            border-radius: 8px;\n            background: #334155;\n            border: 1px solid var(--border);\n            color: var(--text);\n            font-size: 16px;\n            margin-bottom: 16px;\n        }\n        .grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));\n            gap: 12px;\n            margin-bottom: 16px;\n        }\n        @media (max-width: 640px) {\n            .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }\n        }\n        .item {\n            background: #334155;\n            padding: 16px;\n            border-radius: 8px;\n            cursor: pointer;\n            border: 2px solid transparent;\n            transition: all 0.3s;\n            text-align: center;\n        }\n        .item:hover { border-color: var(--primary); background: #3f4a5c; }\n        .item.selected { border-color: var(--secondary); background: rgba(16, 185, 129, 0.1); }\n        .item.loading { opacity: 0.5; cursor: not-allowed; }\n        .loading {\n            text-align: center;\n            padding: 40px;\n        }\n        .spinner {\n            border: 3px solid var(--border);\n            border-top: 3px solid var(--primary);\n            border-radius: 50%;\n            width: 40px;\n            height: 40px;\n            animation: spin 1s linear infinite;\n            margin: 0 auto 16px;\n        }\n        @keyframes spin { 100% { transform: rotate(360deg); } }\n        .progress {\n            display: flex;\n            justify-content: space-between;\n            margin-bottom: 24px;\n            gap: 8px;\n        }\n        .progress-step {\n            flex: 1;\n            text-align: center;\n            padding: 12px;\n            background: #334155;\n            border-radius: 8px;\n            opacity: 0.5;\n            font-size: 13px;\n            font-weight: 600;\n        }\n        .progress-step.active { opacity: 1; background: var(--primary); }\n        .progress-step.completed { opacity: 1; background: var(--secondary); }\n        .button-group {\n            display: flex;\n            gap: 12px;\n            margin-top: 16px;\n        }\n        .button-group .btn { flex: 1; }\n        .info-row {\n            display: flex;\n            justify-content: space-between;\n            padding: 12px 0;\n            border-bottom: 1px solid var(--border);\n        }\n        .info-row:last-child { border-bottom: none; }\n        .info-row span { opacity: 0.8; }\n        .info-row strong { color: var(--text); }\n        .back-btn-container {\n            margin-bottom: 16px;\n        }\n        .service-item-name { font-weight: 600; margin-bottom: 4px; }\n        .service-item-price { font-size: 12px; opacity: 0.7; }\n        .sms-code-display {\n            background: var(--secondary);\n            padding: 24px;\n            border-radius: 12px;\n            text-align: center;\n            margin: 24px 0;\n        }\n        .sms-code-display h2 { font-size: 18px; margin-bottom: 12px; }\n        .sms-code-display .code { font-size: 48px; font-weight: bold; letter-spacing: 4px; margin: 16px 0; }\n        .phone-display {\n            background: #334155;\n            padding: 16px;\n            border-radius: 8px;\n            text-align: center;\n            margin-bottom: 16px;\n        }\n        .phone-display .label { font-size: 12px; opacity: 0.7; }\n        .phone-display .number { font-size: 20px; font-weight: bold; margin-top: 4px; }\n        @media (max-width: 768px) {\n            .header { flex-direction: column; text-align: center; }\n            .balance-widget { min-width: auto; }\n            .container { padding: 12px; }\n            .card { padding: 16px; }\n            .btn { padding: 10px 16px; font-size: 13px; }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"navbar\">\n        <div class=\"navbar-brand\">Namaskah</div>\n        <div class=\"navbar-actions\">\n            <button class=\"btn-home\" onclick=\"goHome()\">Home</button>\n        </div>\n    </div>\n\n    <div class=\"container\">\n        <div class=\"header\">\n            <div>\n                <h1>SMS Verification</h1>\n                <p>Get verification codes instantly</p>\n            </div>\n            <div class=\"balance-widget\">\n                <div class=\"label\">Account Balance</div>\n                <div class=\"amount\">$<span id=\"balance\">0.00</span></div>\n            </div>\n        </div>\n\n        <div id=\"alert\" class=\"alert\"></div>\n\n        <div class=\"progress\">\n            <div class=\"progress-step\" id=\"progress-1\">1. Country</div>\n            <div class=\"progress-step\" id=\"progress-2\">2. Service</div>\n            <div class=\"progress-step\" id=\"progress-3\">3. Review</div>\n            <div class=\"progress-step\" id=\"progress-4\">4. Code</div>\n        </div>\n\n        <!-- Step 1: Select Country -->\n        <div class=\"step active\" id=\"step-1\">\n            <div class=\"card\">\n                <h2>Select Country</h2>\n                <input type=\"text\" id=\"country-search\" class=\"search-box\" \n                       placeholder=\"Search countries...\" oninput=\"filterCountries()\">\n                <div id=\"countries-grid\" class=\"grid\">\n                    <div class=\"loading\"><div class=\"spinner\"></div><p>Loading...</p></div>\n                </div>\n            </div>\n        </div>\n\n        <!-- Step 2: Select Service -->\n        <div class=\"step\" id=\"step-2\">\n            <div class=\"card\">\n                <h2>Select Service</h2>\n                <p style=\"margin-bottom: 16px; opacity: 0.8;\">Country: <strong id=\"selected-country-name\"></strong></p>\n                <input type=\"text\" id=\"service-search\" class=\"search-box\"\n                       placeholder=\"Search services...\" oninput=\"filterServices()\">\n                <div id=\"services-grid\" class=\"grid\">\n                    <div class=\"loading\"><div class=\"spinner\"></div><p>Loading...</p></div>\n                </div>\n                <div class=\"back-btn-container\">\n                    <button class=\"btn btn-secondary\" onclick=\"goToStep(1)\" style=\"width: 100%;\">Back</button>\n                </div>\n            </div>\n        </div>\n\n        <!-- Step 3: Review & Purchase -->\n        <div class=\"step\" id=\"step-3\">\n            <div class=\"card\">\n                <h2>Review & Purchase</h2>\n                <div style=\"background: #334155; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n                    <div class=\"info-row\">\n                        <span>Service:</span>\n                        <strong id=\"purchase-service\"></strong>\n                    </div>\n                    <div class=\"info-row\">\n                        <span>Country:</span>\n                        <strong id=\"purchase-country\"></strong>\n                    </div>\n                    <div class=\"info-row\">\n                        <span>Price:</span>\n                        <strong style=\"color: var(--secondary);\">$<span id=\"purchase-price\"></span></strong>\n                    </div>\n                </div>\n                <button class=\"btn btn-success\" onclick=\"purchaseVerification()\" style=\"width: 100%; padding: 14px; font-size: 16px;\" id=\"purchase-btn\">\n                    Purchase for $<span id=\"final-price\"></span>\n                </button>\n                <button class=\"btn btn-secondary\" onclick=\"goToStep(2)\" style=\"margin-top: 12px; width: 100%;\">Back</button>\n            </div>\n        </div>\n\n        <!-- Step 4: Waiting for SMS -->\n        <div class=\"step\" id=\"step-4\">\n            <div class=\"card\">\n                <h2>Waiting for SMS Code</h2>\n                <div class=\"phone-display\">\n                    <div class=\"label\">Phone Number</div>\n                    <div class=\"number\" id=\"phone-number\"></div>\n                </div>\n                <div style=\"text-align: center; padding: 20px;\">\n                    <div class=\"spinner\" id=\"waiting-spinner\"></div>\n                    <p id=\"waiting-status\" style=\"margin-top: 16px; opacity: 0.8;\">Waiting for SMS code...</p>\n                </div>\n                <div id=\"sms-code\" style=\"display: none;\">\n                    <div class=\"sms-code-display\">\n                        <h2>Code Received</h2>\n                        <div class=\"code\" id=\"code-display\"></div>\n                        <button class=\"btn btn-primary\" onclick=\"copyCode()\" style=\"margin-top: 16px;\">Copy Code</button>\n                    </div>\n                </div>\n                <button class=\"btn btn-danger\" onclick=\"cancelVerification()\" id=\"cancel-btn\" style=\"margin-top: 24px; width: 100%;\">\n                    Cancel & Refund\n                </button>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        let allCountries = [];\n        let allServices = [];\n        let selectedCountry = null;\n        let selectedService = null;\n        let currentStep = 1;\n        let activationId = null;\n        let pollingInterval = null;\n        let pollCount = 0;\n        const MAX_POLLS = 120;\n\n        document.addEventListener('DOMContentLoaded', () => {\n            loadBalance();\n            loadCountries();\n        });\n\n        function showAlert(message, type = 'error') {\n            const alert = document.getElementById('alert');\n            alert.textContent = message;\n            alert.className = `alert show alert-${type}`;\n            setTimeout(() => alert.classList.remove('show'), 5000);\n        }\n\n        function goHome() {\n            window.location.href = '/dashboard-complete';\n        }\n\n        async function loadBalance() {\n            try {\n                const token = localStorage.getItem('token');\n                const response = await fetch('/api/user/balance', {\n                    headers: { 'Authorization': `Bearer ${token}` }\n                });\n                const data = await response.json();\n                document.getElementById('balance').textContent = data.credits.toFixed(2);\n            } catch (error) {\n                console.error('Balance error:', error);\n            }\n        }\n\n        async function loadCountries() {\n            try {\n                const response = await fetch('/api/countries/');\n                const data = await response.json();\n                if (data.success) {\n                    allCountries = data.countries;\n                    displayCountries(allCountries);\n                }\n            } catch (error) {\n                console.error('Countries error:', error);\n                showAlert('Failed to load countries', 'error');\n            }\n        }\n\n        function displayCountries(countries) {\n            const grid = document.getElementById('countries-grid');\n            grid.innerHTML = countries.map(c => `\n                <div class=\"item\" onclick=\"selectCountry('${c.code}', '${c.name}')\">\n                    <div style=\"font-size: 28px; margin-bottom: 8px;\">${c.flag}</div>\n                    <div style=\"font-weight: 600; font-size: 14px;\">${c.name}</div>\n                </div>\n            `).join('');\n        }\n\n        function filterCountries() {\n            const query = document.getElementById('country-search').value.toLowerCase();\n            const filtered = allCountries.filter(c => \n                c.name.toLowerCase().includes(query) || c.code.toLowerCase().includes(query)\n            );\n            displayCountries(filtered);\n        }\n\n        async function selectCountry(code, name) {\n            selectedCountry = { code, name };\n            document.getElementById('selected-country-name').textContent = name;\n            goToStep(2);\n            await loadServices(code);\n        }\n\n        async function loadServices(country) {\n            try {\n                const grid = document.getElementById('services-grid');\n                grid.innerHTML = '<div class=\"loading\"><div class=\"spinner\"></div><p>Loading services...</p></div>';\n                \n                const response = await fetch(`/api/countries/${country}/services`);\n                const data = await response.json();\n                if (data.success) {\n                    allServices = data.services;\n                    displayServices(allServices);\n                }\n            } catch (error) {\n                console.error('Services error:', error);\n                showAlert('Failed to load services', 'error');\n            }\n        }\n\n        function displayServices(services) {\n            const grid = document.getElementById('services-grid');\n            grid.innerHTML = services.map(s => `\n                <div class=\"item\" onclick=\"selectService('${s.id}', '${s.name}', ${s.price || 0})\">\n                    <div class=\"service-item-name\">${s.name}</div>\n                    <div class=\"service-item-price\">$${(s.price || 0).toFixed(2)}</div>\n                </div>\n            `).join('');\n        }\n\n        function filterServices() {\n            const query = document.getElementById('service-search').value.toLowerCase();\n            const filtered = allServices.filter(s => \n                s.name.toLowerCase().includes(query) || s.id.toLowerCase().includes(query)\n            );\n            displayServices(filtered);\n        }\n\n        function selectService(id, name, price) {\n            selectedService = { id, name, price };\n            document.getElementById('purchase-service').textContent = name;\n            document.getElementById('purchase-country').textContent = selectedCountry.name;\n            document.getElementById('purchase-price').textContent = price.toFixed(2);\n            document.getElementById('final-price').textContent = price.toFixed(2);\n            goToStep(3);\n        }\n\n        async function purchaseVerification() {\n            const btn = document.getElementById('purchase-btn');\n            btn.disabled = true;\n            btn.textContent = 'Processing...';\n            \n            try {\n                const token = localStorage.getItem('token');\n                const response = await fetch('/api/verify/create', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Authorization': `Bearer ${token}`\n                    },\n                    body: JSON.stringify({\n                        service: selectedService.id,\n                        country: selectedCountry.code\n                    })\n                });\n                \n                const data = await response.json();\n                \n                if (response.ok && data.success) {\n                    activationId = data.id;\n                    document.getElementById('phone-number').textContent = data.phone_number;\n                    pollCount = 0;\n                    goToStep(4);\n                    startPolling();\n                    loadBalance();\n                    showAlert('Verification purchased!', 'success');\n                } else {\n                    showAlert(data.message || 'Failed to purchase', 'error');\n                }\n            } catch (error) {\n                console.error('Purchase error:', error);\n                showAlert('Network error', 'error');\n            } finally {\n                btn.disabled = false;\n                btn.textContent = 'Purchase for $' + selectedService.price.toFixed(2);\n            }\n        }\n\n        function startPolling() {\n            pollingInterval = setInterval(checkForSMS, 5000);\n        }\n\n        async function checkForSMS() {\n            pollCount++;\n            if (pollCount > MAX_POLLS) {\n                clearInterval(pollingInterval);\n                document.getElementById('waiting-spinner').style.display = 'none';\n                document.getElementById('waiting-status').textContent = 'SMS timeout - code not received';\n                return;\n            }\n\n            try {\n                const token = localStorage.getItem('token');\n                const response = await fetch(`/api/verify/status/${activationId}`, {\n                    headers: { 'Authorization': `Bearer ${token}` }\n                });\n                \n                const data = await response.json();\n                if (data.success && data.sms_codes && data.sms_codes.length > 0) {\n                    clearInterval(pollingInterval);\n                    document.getElementById('waiting-spinner').style.display = 'none';\n                    document.getElementById('code-display').textContent = data.sms_codes[0];\n                    document.getElementById('sms-code').style.display = 'block';\n                    document.getElementById('waiting-status').style.display = 'none';\n                    showAlert('SMS received!', 'success');\n                }\n            } catch (error) {\n                console.error('Polling error:', error);\n            }\n        }\n\n        function copyCode() {\n            const code = document.getElementById('code-display').textContent;\n            navigator.clipboard.writeText(code).then(() => {\n                showAlert('Code copied to clipboard!', 'success');\n            }).catch(() => {\n                showAlert('Failed to copy code', 'error');\n            });\n        }\n\n        async function cancelVerification() {\n            if (!confirm('Cancel verification and refund?')) return;\n            \n            try {\n                clearInterval(pollingInterval);\n                const token = localStorage.getItem('token');\n                const response = await fetch(`/api/verify/${activationId}`, {\n                    method: 'DELETE',\n                    headers: { 'Authorization': `Bearer ${token}` }\n                });\n                \n                if (response.ok) {\n                    showAlert('Cancelled and refunded!', 'success');\n                    loadBalance();\n                    setTimeout(() => goToStep(1), 1500);\n                }\n            } catch (error) {\n                console.error('Cancel error:', error);\n                showAlert('Failed to cancel', 'error');\n            }\n        }\n\n        function goToStep(step) {\n            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));\n            document.getElementById(`step-${step}`).classList.add('active');\n            \n            for (let i = 1; i <= 4; i++) {\n                const el = document.getElementById(`progress-${i}`);\n                el.classList.remove('active', 'completed');\n                if (i < step) el.classList.add('completed');\n                if (i === step) el.classList.add('active');\n            }\n            \n            currentStep = step;\n            window.scrollTo({ top: 0, behavior: 'smooth' });\n        }\n    </script>\n</body>\n</html>\n