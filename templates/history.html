{% extends "dashboard_base.html" %}

{% block page_title %}History{% endblock %}
{% block page_subtitle %}Your verification history{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 16px;">
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <select id="filter-status" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px;">
            <option value="">All Status</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
            <option value="failed">Failed</option>
        </select>
        <input type="date" id="filter-date" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px;">
        <button class="btn" onclick="applyFilters()" style="padding: 8px 16px;">Filter</button>
        <button class="btn" onclick="clearFilters()" style="padding: 8px 16px; background: #6b7280;">Clear</button>
        <button class="btn" onclick="exportHistory()" style="padding: 8px 16px; background: #10b981; margin-left: auto;">ðŸ“¥ Export CSV</button>
    </div>
</div>

<div class="card">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Service</th>
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Country</th>
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Number</th>
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Status</th>
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Cost</th>
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Date</th>
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Actions</th>
            </tr>
        </thead>
        <tbody id="history-body">
            <tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</td></tr>
        </tbody>
    </table>
</div>

<div id="empty-state" style="text-align: center; padding: 60px; color: var(--text-muted); display: none;">
    <div style="font-size: 64px; margin-bottom: 16px;">ðŸ“­</div>
    <h3 style="margin-bottom: 8px;">No verification history</h3>
    <p style="margin-bottom: 24px;">Start your first verification to see it here</p>
    <button class="btn" onclick="window.location.href='/verify'">Get SMS Code</button>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let allHistory = [];

async function loadHistory() {
    try {
        const res = await fetch('/api/wallet/transactions?limit=100');
        const tbody = document.getElementById('history-body');
        const emptyState = document.getElementById('empty-state');
        
        if (res.ok) {
            const data = await res.json();
            allHistory = data.transactions || [];
            
            const verifications = allHistory.filter(tx => 
                tx.type === 'SMS Verification' || 
                tx.description?.includes('Verification')
            );
            
            if (verifications.length > 0) {
                renderHistory(verifications);
                emptyState.style.display = 'none';
            } else {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
            }
        }
    } catch (error) {
        document.getElementById('history-body').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #ef4444;">Failed to load history</td></tr>';
    }
}

function renderHistory(items) {
    const tbody = document.getElementById('history-body');
    tbody.innerHTML = items.map(item => {
        const parts = (item.description || '').split(' - ');
        const service = parts[0] || 'Unknown';
        const country = parts[1] || 'USA';
        const status = item.status || 'completed';
        const statusColor = status === 'completed' ? '#d5f4e6' : status === 'failed' ? '#fee2e2' : '#fef3c7';
        const statusText = status === 'completed' ? '#166534' : status === 'failed' ? '#991b1b' : '#92400e';
        
        return `
            <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                <td style="padding: 12px;">${service}</td>
                <td style="padding: 12px;">${country}</td>
                <td style="padding: 12px;">+1 XXX-XXXX</td>
                <td style="padding: 12px;"><span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${statusColor}; color: ${statusText};">${status}</span></td>
                <td style="padding: 12px;">$${Math.abs(item.amount).toFixed(2)}</td>
                <td style="padding: 12px;">${new Date(item.created_at).toLocaleDateString()}</td>
                <td style="padding: 12px;">
                    <button onclick="viewDetails('${item.id}')" style="padding: 4px 8px; font-size: 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">View</button>
                </td>
            </tr>
        `;
    }).join('');
}

function applyFilters() {
    const status = document.getElementById('filter-status').value;
    const date = document.getElementById('filter-date').value;
    
    let filtered = allHistory.filter(tx => 
        tx.type === 'SMS Verification' || 
        tx.description?.includes('Verification')
    );
    
    if (status) {
        filtered = filtered.filter(tx => tx.status === status);
    }
    
    if (date) {
        const filterDate = new Date(date).toDateString();
        filtered = filtered.filter(tx => new Date(tx.created_at).toDateString() === filterDate);
    }
    
    renderHistory(filtered);
}

function clearFilters() {
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-date').value = '';
    loadHistory();
}

function viewDetails(id) {
    alert(`Viewing details for verification ${id}`);
}

function exportHistory() {
    const csv = [
        ['Service', 'Country', 'Status', 'Cost', 'Date'],
        ...allHistory
            .filter(tx => tx.type === 'SMS Verification' || tx.description?.includes('Verification'))
            .map(tx => {
                const parts = (tx.description || '').split(' - ');
                return [
                    parts[0] || 'Unknown',
                    parts[1] || 'USA',
                    tx.status || 'completed',
                    Math.abs(tx.amount).toFixed(2),
                    new Date(tx.created_at).toLocaleDateString()
                ];
            })
    ].map(row => row.join(',')).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `verification-history-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

document.addEventListener('DOMContentLoaded', loadHistory);
</script>
{% endblock %}
