<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; }
        .container { padding: 12px; }
        
        .admin-header { background: white; padding: 12px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 12px; }
        .admin-header h1 { font-size: 20px; margin-bottom: 4px; }
        .admin-header p { font-size: 12px; color: #666; margin-bottom: 8px; }
        .admin-nav { display: flex; gap: 8px; flex-wrap: wrap; }
        .admin-nav button { padding: 6px 12px; font-size: 11px; border: none; border-radius: 3px; cursor: pointer; color: white; font-weight: 500; transition: opacity 0.2s; }
        .admin-nav button:hover { opacity: 0.9; }
        .admin-nav .active { background: #2c3e50; }
        .admin-nav .nav-dashboard { background: #3498db; }
        .admin-nav .nav-tier { background: #27ae60; }
        .admin-nav .nav-pricing { background: #e67e22; }
        .admin-nav .nav-history { background: #e74c3c; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; }
        .card { background: white; border-radius: 6px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .card h3 { font-size: 12px; color: #666; margin-bottom: 8px; text-transform: uppercase; }
        .chart-container { position: relative; height: 200px; }
        
        .table-card { grid-column: span 2; }
        .table-card table { width: 100%; font-size: 12px; border-collapse: collapse; }
        .table-card th { background: #f8f9fa; padding: 6px; text-align: left; font-weight: 600; border-bottom: 1px solid #e9ecef; }
        .table-card td { padding: 6px; border-bottom: 1px solid #e9ecef; }
        .table-card tbody { max-height: 200px; overflow-y: auto; display: block; }
        .table-card thead { display: block; width: 100%; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; }
        .badge.payg { background: #ecf0f1; color: #7f8c8d; }
        .badge.starter { background: #d5f4e6; color: #27ae60; }
        .badge.pro { background: #d6eaf8; color: #2980b9; }
        .badge.custom { background: #fadbd8; color: #c0392b; }
        
        .actions { display: flex; gap: 4px; }
        button { padding: 4px 8px; font-size: 10px; border: none; border-radius: 3px; cursor: pointer; background: #3498db; color: white; }
        button:hover { background: #2980b9; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 20px; border-radius: 6px; max-width: 400px; width: 90%; }
        .modal-header { font-size: 16px; font-weight: bold; margin-bottom: 12px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 11px; margin-bottom: 3px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; }
        .modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
        
        .alert { padding: 8px; border-radius: 3px; font-size: 11px; margin-bottom: 8px; display: none; }
        .alert.show { display: block; }
        .alert.success { background: #d5f4e6; color: #27ae60; }
        .alert.error { background: #fadbd8; color: #c0392b; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="admin-header">
            <h1>üéØ Admin Dashboard</h1>
            <p>Tier Management ‚Ä¢ User Stats ‚Ä¢ Quick Actions</p>
            <div class="admin-nav">
                <button class="nav-dashboard active" id="btn-dashboard" onclick="window.location.href='/admin'">üìä Dashboard</button>
                <button class="nav-tier" id="btn-tier" onclick="window.location.href='/admin/tier-management'">üéØ Tier Management</button>
                <button class="nav-pricing" id="btn-pricing" onclick="window.location.href='/admin/pricing-templates'">üí∞ Pricing</button>
                <button class="nav-history" id="btn-history" onclick="window.location.href='/admin/verification-history'">üìã History</button>
            </div>
        </div>
        
        <!-- Charts Grid -->
        <div class="grid">
            <!-- Tier Distribution Donut -->
            <div class="card">
                <h3>Tier Distribution</h3>
                <div class="chart-container">
                    <canvas id="tierChart"></canvas>
                </div>
            </div>
            
            <!-- Verification Status Donut -->
            <div class="card">
                <h3>Verification Status</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="card">
                <h3>Quick Stats</h3>
                <div style="font-size: 12px; line-height: 1.8;">
                    <div>üë• Total Users: <strong id="stat-users">0</strong></div>
                    <div>‚úÖ Successful: <strong id="stat-success">0</strong></div>
                    <div>‚è≥ Pending: <strong id="stat-pending">0</strong></div>
                    <div>üí∞ Revenue: <strong id="stat-revenue">$0</strong></div>
                </div>
            </div>
            
            <!-- Users Table -->
            <div class="card table-card">
                <h3>Recent Users</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Tier</th>
                            <th>Expires</th>
                            <th>Credits</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table"></tbody>
                </table>
            </div>
            
            <!-- Actions -->
            <div class="card">
                <h3>Quick Actions</h3>
                <button onclick="openEditModal()" style="width: 100%; margin-bottom: 6px;">Edit User Tier</button>
                <button onclick="openBulkModal()" style="width: 100%; margin-bottom: 6px;">Bulk Update</button>
                <button onclick="loadData()" style="width: 100%;">üîÑ Refresh</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div id="alert" class="alert"></div>
            <div class="modal-header">Edit User Tier</div>
            <div class="form-group">
                <label>User Email:</label>
                <input type="text" id="editEmail" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label>New Tier:</label>
                <select id="editTier">
                    <option value="payg">Pay-As-You-Go</option>
                    <option value="starter">Starter</option>
                    <option value="pro">Pro</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label>Duration (days):</label>
                <input type="number" id="editDays" value="30" min="1" max="365">
            </div>
            <div class="modal-footer">
                <button onclick="closeEditModal()">Cancel</button>
                <button onclick="saveEdit()" style="background: #27ae60;">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Modal -->
    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Bulk Update Tiers</div>
            <div class="form-group">
                <label>User IDs (comma-separated):</label>
                <textarea id="bulkIds" style="width: 100%; height: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;"></textarea>
            </div>
            <div class="form-group">
                <label>New Tier:</label>
                <select id="bulkTier">
                    <option value="payg">Pay-As-You-Go</option>
                    <option value="starter">Starter</option>
                    <option value="pro">Pro</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label>Duration (days):</label>
                <input type="number" id="bulkDays" value="30" min="1" max="365">
            </div>
            <div class="modal-footer">
                <button onclick="closeBulkModal()">Cancel</button>
                <button onclick="saveBulk()" style="background: #27ae60;">Update</button>
            </div>
        </div>
    </div>
    
    <script>
        const token = localStorage.getItem('access_token');
        let tierChart, statusChart;
        
        async function loadData() {
            try {
                const statsRes = await fetch('/api/admin/tiers/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await statsRes.json();
                renderTierChart(stats.stats);
                
                const usersRes = await fetch('/api/admin/tiers/users?limit=10', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await usersRes.json();
                renderUsers(users.users);
                renderStats(users.users, stats.stats);
                
                const expiringRes = await fetch('/api/admin/tiers/expiring?days=7', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const expiring = await expiringRes.json();
                renderStatusChart(users.users);
            } catch (e) {
                console.error(e);
            }
        }
        
        function renderTierChart(stats) {
            const ctx = document.getElementById('tierChart').getContext('2d');
            const colors = ['#95a5a6', '#27ae60', '#2980b9', '#e74c3c'];
            
            if (tierChart) tierChart.destroy();
            tierChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: stats.map(s => s.tier.toUpperCase()),
                    datasets: [{
                        data: stats.map(s => s.user_count),
                        backgroundColor: colors,
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } }
                }
            });
        }
        
        function renderStatusChart(users) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const pending = users.filter(u => !u.tier_expires_at || new Date(u.tier_expires_at) > new Date()).length;
            const expired = users.length - pending;
            
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Expiring'],
                    datasets: [{
                        data: [pending, expired],
                        backgroundColor: ['#27ae60', '#e74c3c'],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } }
                }
            });
        }
        
        function renderStats(users, stats) {
            const totalUsers = stats.reduce((sum, s) => sum + s.user_count, 0);
            document.getElementById('stat-users').textContent = totalUsers;
            document.getElementById('stat-success').textContent = users.filter(u => u.tier !== 'payg').length;
            document.getElementById('stat-pending').textContent = users.filter(u => !u.tier_expires_at).length;
            document.getElementById('stat-revenue').textContent = '$' + (users.reduce((sum, u) => sum + u.credits, 0) / 100).toFixed(2);
        }
        
        function renderUsers(users) {
            const html = users.map(u => `
                <tr>
                    <td>${u.email}</td>
                    <td><span class="badge ${u.tier}">${u.tier.toUpperCase()}</span></td>
                    <td>${u.tier_expires_at ? new Date(u.tier_expires_at).toLocaleDateString() : 'N/A'}</td>
                    <td>$${u.credits.toFixed(2)}</td>
                    <td><div class="actions"><button onclick="editUser('${u.id}', '${u.email}')">Edit</button><button onclick="resetUser('${u.id}')" class="danger">Reset</button></div></td>
                </tr>
            `).join('');
            document.getElementById('users-table').innerHTML = html;
        }
        
        function openEditModal() { document.getElementById('editModal').classList.add('active'); }
        function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }
        function editUser(id, email) {
            document.getElementById('editEmail').value = email;
            document.getElementById('editEmail').dataset.id = id;
            openEditModal();
        }
        
        async function saveEdit() {
            const id = document.getElementById('editEmail').dataset.id;
            const tier = document.getElementById('editTier').value;
            const days = parseInt(document.getElementById('editDays').value);
            
            try {
                const res = await fetch(`/api/admin/tiers/users/${id}/tier`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tier, duration_days: days })
                });
                if (res.ok) {
                    closeEditModal();
                    loadData();
                }
            } catch (e) { console.error(e); }
        }
        
        async function resetUser(id) {
            if (!confirm('Reset to Pay-As-You-Go?')) return;
            try {
                const res = await fetch(`/api/admin/tiers/users/${id}/tier`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) loadData();
            } catch (e) { console.error(e); }
        }
        
        function openBulkModal() { document.getElementById('bulkModal').classList.add('active'); }
        function closeBulkModal() { document.getElementById('bulkModal').classList.remove('active'); }
        
        async function saveBulk() {
            const ids = document.getElementById('bulkIds').value.split(',').map(id => id.trim()).filter(id => id);
            const tier = document.getElementById('bulkTier').value;
            const days = parseInt(document.getElementById('bulkDays').value);
            
            try {
                const res = await fetch('/api/admin/tiers/users/bulk/tier', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_ids: ids, tier, duration_days: days })
                });
                if (res.ok) {
                    closeBulkModal();
                    loadData();
                }
            } catch (e) { console.error(e); }
        }
        
        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
