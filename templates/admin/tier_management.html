<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tier Management - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .breadcrumb {
            font-size: 14px;
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-card .percentage {
            font-size: 12px;
            color: #27ae60;
            margin-top: 5px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group label {
            font-weight: 500;
            color: #555;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        button.success {
            background: #27ae60;
        }
        
        button.success:hover {
            background: #229954;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .tier-payg {
            background: #ecf0f1;
            color: #7f8c8d;
        }
        
        .tier-starter {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .tier-pro {
            background: #d6eaf8;
            color: #2980b9;
        }
        
        .tier-custom {
            background: #fadbd8;
            color: #c0392b;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .actions button {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert.success {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .alert.error {
            background: #fadbd8;
            color: #c0392b;
            border: 1px solid #c0392b;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pagination {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .pagination button {
            padding: 6px 12px;
            min-width: 40px;
        }
        
        .pagination button.active {
            background: #2c3e50;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸŽ¯ Tier Management</h1>
            <div class="breadcrumb">Admin Dashboard > Subscription Tiers</div>
        </header>
        
        <div id="alert" class="alert"></div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="loading show"><div class="spinner"></div></div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Filter by Tier:</label>
                <select id="tierFilter">
                    <option value="">All Tiers</option>
                    <option value="payg">Pay-As-You-Go</option>
                    <option value="starter">Starter</option>
                    <option value="pro">Pro</option>
                    <option value="custom">Custom</option>
                </select>
                
                <label style="margin-left: 20px;">Search:</label>
                <input type="text" id="searchInput" placeholder="Email or User ID...">
                
                <button onclick="loadUsers()" style="margin-left: auto;">ðŸ”„ Refresh</button>
                <button onclick="openBulkModal()" class="success">ðŸ“‹ Bulk Update</button>
            </div>
        </div>
        
        <div class="table-container">
            <div id="loading" class="loading"><div class="spinner"></div></div>
            <table id="usersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Current Tier</th>
                        <th>Expires</th>
                        <th>Credits</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
            <div id="emptyState" class="empty-state" style="display: none;">
                <p>No users found</p>
            </div>
        </div>
        
        <div class="pagination" id="pagination"></div>
    </div>
    
    <!-- Edit Tier Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Change User Tier</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>User Email:</label>
                    <input type="text" id="editUserEmail" readonly>
                </div>
                <div class="form-group">
                    <label>New Tier:</label>
                    <select id="editTier">
                        <option value="payg">Pay-As-You-Go</option>
                        <option value="starter">Starter ($8.99/mo)</option>
                        <option value="pro">Pro ($25/mo)</option>
                        <option value="custom">Custom ($35/mo)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Duration (days):</label>
                    <input type="number" id="editDuration" value="30" min="1" max="365">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeEditModal()">Cancel</button>
                <button onclick="saveTierChange()" class="success">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Update Modal -->
    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Bulk Update Tiers</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>User IDs (comma-separated):</label>
                    <textarea id="bulkUserIds" style="width: 100%; height: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div class="form-group">
                    <label>New Tier:</label>
                    <select id="bulkTier">
                        <option value="payg">Pay-As-You-Go</option>
                        <option value="starter">Starter ($8.99/mo)</option>
                        <option value="pro">Pro ($25/mo)</option>
                        <option value="custom">Custom ($35/mo)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Duration (days):</label>
                    <input type="number" id="bulkDuration" value="30" min="1" max="365">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeBulkModal()">Cancel</button>
                <button onclick="saveBulkUpdate()" class="success">Update All</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentPage = 0;
        const pageSize = 50;
        let currentTierFilter = '';
        let currentSearchQuery = '';
        let editingUserId = null;
        
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/tiers/stats', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Failed to load stats');
                
                const data = await response.json();
                renderStats(data.stats);
            } catch (error) {
                showAlert('Error loading statistics: ' + error.message, 'error');
            }
        }
        
        function renderStats(stats) {
            const grid = document.getElementById('statsGrid');
            grid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <h3>${stat.tier.toUpperCase()}</h3>
                    <div class="value">${stat.user_count}</div>
                    <div class="percentage">${stat.percentage}% of users</div>
                </div>
            `).join('');
        }
        
        async function loadUsers(page = 0) {
            currentPage = page;
            const tier = document.getElementById('tierFilter').value;
            const search = document.getElementById('searchInput').value;
            
            currentTierFilter = tier;
            currentSearchQuery = search;
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('usersTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            
            try {
                let url = `/api/admin/tiers/users?limit=${pageSize}&offset=${page * pageSize}`;
                if (tier) url += `&tier=${tier}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Failed to load users');
                
                const data = await response.json();
                
                if (search) {
                    data.users = data.users.filter(u => 
                        u.email.toLowerCase().includes(search.toLowerCase()) ||
                        u.id.toLowerCase().includes(search.toLowerCase())
                    );
                }
                
                renderUsers(data.users);
                renderPagination(data.total, page);
                
                document.getElementById('loading').classList.remove('show');
                if (data.users.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    document.getElementById('usersTable').style.display = 'table';
                }
            } catch (error) {
                showAlert('Error loading users: ' + error.message, 'error');
                document.getElementById('loading').classList.remove('show');
            }
        }
        
        function renderUsers(users) {
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.email}</td>
                    <td><span class="tier-badge tier-${user.tier}">${user.tier.toUpperCase()}</span></td>
                    <td>${user.tier_expires_at ? new Date(user.tier_expires_at).toLocaleDateString() : 'N/A'}</td>
                    <td>$${user.credits.toFixed(2)}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <div class="actions">
                            <button onclick="openEditModal('${user.id}', '${user.email}')">Edit</button>
                            <button onclick="resetTier('${user.id}')" class="danger">Reset</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderPagination(total, currentPage) {
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 0; i < totalPages; i++) {
                html += `<button onclick="loadUsers(${i})" ${i === currentPage ? 'class="active"' : ''}>${i + 1}</button>`;
            }
            pagination.innerHTML = html;
        }
        
        function openEditModal(userId, email) {
            editingUserId = userId;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingUserId = null;
        }
        
        async function saveTierChange() {
            if (!editingUserId) return;
            
            const tier = document.getElementById('editTier').value;
            const duration = parseInt(document.getElementById('editDuration').value);
            
            try {
                const response = await fetch(`/api/admin/tiers/users/${editingUserId}/tier`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tier, duration_days: duration })
                });
                
                if (!response.ok) throw new Error('Failed to update tier');
                
                const data = await response.json();
                showAlert(data.message, 'success');
                closeEditModal();
                loadUsers(currentPage);
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function resetTier(userId) {
            if (!confirm('Reset this user to Pay-As-You-Go tier?')) return;
            
            try {
                const response = await fetch(`/api/admin/tiers/users/${userId}/tier`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Failed to reset tier');
                
                const data = await response.json();
                showAlert(data.message, 'success');
                loadUsers(currentPage);
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        function openBulkModal() {
            document.getElementById('bulkModal').classList.add('active');
        }
        
        function closeBulkModal() {
            document.getElementById('bulkModal').classList.remove('active');
            document.getElementById('bulkUserIds').value = '';
        }
        
        async function saveBulkUpdate() {
            const userIds = document.getElementById('bulkUserIds').value
                .split(',')
                .map(id => id.trim())
                .filter(id => id.length > 0);
            
            if (userIds.length === 0) {
                showAlert('Please enter at least one user ID', 'error');
                return;
            }
            
            const tier = document.getElementById('bulkTier').value;
            const duration = parseInt(document.getElementById('bulkDuration').value);
            
            try {
                const response = await fetch('/api/admin/tiers/users/bulk/tier', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_ids: userIds, tier, duration_days: duration })
                });
                
                if (!response.ok) throw new Error('Failed to bulk update');
                
                const data = await response.json();
                showAlert(`${data.updated_count} users updated successfully`, 'success');
                closeBulkModal();
                loadUsers(0);
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert show ${type}`;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }
        
        // Event listeners
        document.getElementById('tierFilter').addEventListener('change', () => loadUsers(0));
        document.getElementById('searchInput').addEventListener('keyup', () => loadUsers(0));
        
        // Initial load
        loadStats();
        loadUsers();
    </script>
</body>
</html>
