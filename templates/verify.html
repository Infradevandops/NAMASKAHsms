{% extends "dashboard_base.html" %}

{% block page_title %}SMS Verification{% endblock %}
{% block page_subtitle %}Get instant SMS codes for any service{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 450px 1fr; gap: 24px;">
    <div class="card">
        <h2 style="font-size: 18px; margin-bottom: 20px;">üì± Request SMS Code</h2>
        
        <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">Service</label>
            <input type="text" id="service-search" placeholder="Type to search..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            <div id="service-dropdown" style="display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; width: 400px; margin-top: 4px; box-shadow: var(--shadow-soft); z-index: 100;"></div>
        </div>
        
        <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">Country</label>
            <input type="text" value="üá∫üá∏ United States" readonly style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #f9fafb; cursor: not-allowed;">
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
            <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: 700; color: var(--primary);" id="service-cost">$0.00</div>
                <div style="font-size: 12px; color: var(--text-muted);">Cost</div>
            </div>
            <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: 700;">~30s</div>
                <div style="font-size: 12px; color: var(--text-muted);">Delivery</div>
            </div>
            <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: 700;">95%</div>
                <div style="font-size: 12px; color: var(--text-muted);">Success</div>
            </div>
        </div>
        
        <button class="btn" id="purchase-btn" onclick="purchaseVerification()" disabled style="width: 100%;">Select service</button>
    </div>
    
    <div class="card">
        <h2 style="font-size: 18px; margin-bottom: 20px;">üì≤ SMS Reception</h2>
        
        <div id="waiting-area" style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div style="font-size: 48px; margin-bottom: 12px;">üì°</div>
            <div>Ready to receive SMS</div>
            <div style="font-size: 12px; margin-top: 4px;">Complete form to get phone number</div>
        </div>
        
        <div id="result-area" style="display: none; text-align: center;">
            <div id="phone-display" style="font-size: 18px; font-weight: 700; background: var(--primary-light); padding: 16px; border-radius: 12px; margin-bottom: 16px; color: var(--primary);"></div>
            <div id="status-text" style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">‚è≥ Waiting for SMS...</div>
            <div id="code-display" style="font-size: 32px; font-weight: 700; color: var(--primary); letter-spacing: 2px; margin: 16px 0;">------</div>
            <div style="display: flex; gap: 8px;">
                <button class="btn" id="copy-btn" onclick="copyCode()" style="flex: 1; display: none;">üìã Copy</button>
                <button class="btn" onclick="resetForm()" style="flex: 1; background: #6b7280;">üîÑ Reset</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
let selectedService = null;
let currentVerification = null;
let pollingInterval = null;
let allServices = [];

async function loadServices() {
    try {
        const res = await axios.get('/api/verification/textverified/services');
        if (res.data && res.data.services) {
            allServices = res.data.services;
            console.log(`Loaded ${allServices.length} services`);
        }
    } catch (error) {
        console.error('Failed to load services:', error);
    }
}

document.getElementById('service-search').addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    const dropdown = document.getElementById('service-dropdown');
    
    if (!query) {
        dropdown.style.display = 'none';
        return;
    }
    
    const filtered = allServices.filter(s => s.name.toLowerCase().includes(query));
    dropdown.innerHTML = filtered.map(s => `
        <div onclick="selectService('${s.id}', '${s.name}', ${s.cost})" style="padding: 12px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05);">
            ${s.name} ($${s.cost.toFixed(2)})
        </div>
    `).join('');
    dropdown.style.display = filtered.length > 0 ? 'block' : 'none';
});

function selectService(id, name, cost) {
    selectedService = id;
    document.getElementById('service-search').value = name;
    document.getElementById('service-cost').textContent = `$${cost.toFixed(2)}`;
    document.getElementById('service-dropdown').style.display = 'none';
    document.getElementById('purchase-btn').disabled = false;
    document.getElementById('purchase-btn').textContent = '‚ö° Get SMS Code';
}

async function purchaseVerification() {
    if (!selectedService) return;
    
    const btn = document.getElementById('purchase-btn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Processing...';
    
    try {
        const res = await axios.post('/api/verify/create', {
            service_name: selectedService,
            country: 'US',
            capability: 'sms'
        });
        
        if (res.data && res.data.phone_number) {
            currentVerification = res.data;
            document.getElementById('phone-display').textContent = res.data.phone_number;
            document.getElementById('waiting-area').style.display = 'none';
            document.getElementById('result-area').style.display = 'block';
            startPolling(res.data.id);
            loadBalance();
        }
    } catch (error) {
        alert(error.response?.data?.detail || 'Purchase failed');
        btn.disabled = false;
        btn.textContent = '‚ö° Get SMS Code';
    }
}

function startPolling(id) {
    let count = 0;
    pollingInterval = setInterval(async () => {
        count++;
        try {
            const res = await axios.get(`/api/verify/${id}/status`);
            if (res.data.sms_code) {
                document.getElementById('code-display').textContent = res.data.sms_code;
                document.getElementById('status-text').textContent = '‚úÖ SMS received!';
                document.getElementById('copy-btn').style.display = 'block';
                clearInterval(pollingInterval);
            } else if (count >= 60) {
                document.getElementById('status-text').textContent = '‚è±Ô∏è Timeout';
                clearInterval(pollingInterval);
            }
        } catch (error) {
            if (count >= 60) clearInterval(pollingInterval);
        }
    }, 5000);
}

function copyCode() {
    const code = document.getElementById('code-display').textContent;
    navigator.clipboard.writeText(code).then(() => {
        document.getElementById('copy-btn').textContent = '‚úÖ Copied!';
        setTimeout(() => {
            document.getElementById('copy-btn').textContent = 'üìã Copy';
        }, 2000);
    });
}

async function resetForm() {
    if (currentVerification) {
        try {
            await axios.delete(`/api/verify/${currentVerification.id}`);
        } catch (error) {}
    }
    
    selectedService = null;
    currentVerification = null;
    if (pollingInterval) clearInterval(pollingInterval);
    
    document.getElementById('service-search').value = '';
    document.getElementById('waiting-area').style.display = 'block';
    document.getElementById('result-area').style.display = 'none';
    document.getElementById('code-display').textContent = '------';
    document.getElementById('copy-btn').style.display = 'none';
    document.getElementById('purchase-btn').disabled = true;
    document.getElementById('purchase-btn').textContent = 'Select service';
    loadBalance();
}

document.addEventListener('DOMContentLoaded', loadServices);
</script>
{% endblock %}
