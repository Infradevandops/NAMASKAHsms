{% extends "dashboard_base.html" %}

{% block page_title %}Profile{% endblock %}
{% block page_subtitle %}Manage your public profile{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
    .profile-header {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 40px;
        display: flex;
        align-items: center;
        gap: 32px;
        margin-bottom: 32px;
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    .profile-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 120px;
        background: linear-gradient(90deg, var(--primary) 0%, #a29bfe 100%);
        opacity: 0.2;
        z-index: 0;
    }

    .avatar-container {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--bg-card);
        background: var(--bg-body);
        z-index: 1;
        overflow: hidden;
        cursor: pointer;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 14px;
        font-weight: 600;
    }

    .avatar-container:hover .avatar-overlay {
        opacity: 1;
    }

    .profile-info {
        z-index: 1;
        flex: 1;
    }

    .profile-name {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .profile-email {
        color: var(--text-secondary);
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
    }

    .card-form {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 24px;
        border: 1px solid var(--border-color);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
        margin-top: 24px;
    }

    .stat-card {
        background: var(--bg-body);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary);
    }

    .stat-label {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .tier-badge-profile {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .tier-badge-freemium { background: #e5e7eb; color: #374151; }
    .tier-badge-payg { background: rgba(255, 120, 84, 0.15); color: #FF7854; }
    .tier-badge-pro { background: #fef3c7; color: #92400e; }
    .tier-badge-custom { background: #ede9fe; color: #6d28d9; }

    .avatar-upload-input {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-header">
    <div class="profile-bg"></div>
    <div class="avatar-container" onclick="triggerAvatarUpload()" role="button" tabindex="0" aria-label="Change profile picture">
        <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&background=random" class="avatar-img" alt="Profile avatar">
        <div class="avatar-overlay">üì∑ Change</div>
        <input type="file" id="avatar-upload" class="avatar-upload-input" accept="image/*" onchange="handleAvatarUpload(event)">
    </div>
    <div class="profile-info">
        <h1 class="profile-name">
            <span id="display-name">Loading...</span>
            <span id="tier-badge" class="tier-badge-profile tier-badge-freemium">Free</span>
        </h1>
        <div class="profile-email">
            <span id="display-email">...</span>
            <span class="badge badge-success" id="email-verified-badge" style="display:none; font-size: 10px;">‚úì Verified</span>
        </div>
        <div style="margin-top: 12px; font-size: 14px; color: var(--text-muted);">
            Member since <span id="member-since">...</span>
        </div>
    </div>
</div>

<!-- Verification Stats -->
<div class="card" style="margin-bottom: 24px;">
    <h3 style="margin-bottom: 16px;">Verification Statistics</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">Total Verifications</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-success" style="color: #10b981;">0</div>
            <div class="stat-label">Successful</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-month">0</div>
            <div class="stat-label">This Month</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-balance">$0</div>
            <div class="stat-label">Balance</div>
        </div>
    </div>
</div>

<div class="form-grid">
    <div class="card card-form">
        <h3>Personal Details</h3>
        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">Display Name</label>
            <input type="text" class="form-input" id="profile-display-name" placeholder="Enter display name">
        </div>

        <div class="form-group">
            <label class="form-label">Email Address</label>
            <input type="email" class="form-input" id="profile-email-input" readonly>
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 6px;">Contact support to change email.</p>
        </div>

        <div class="form-group">
            <label class="form-label">Language</label>
            <select class="form-input" id="profile-language">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="pt">Portuguese</option>
                <option value="zh">Chinese</option>
                <option value="ja">Japanese</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Currency</label>
            <select class="form-input" id="profile-currency">
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (‚Ç¨)</option>
                <option value="GBP">GBP (¬£)</option>
                <option value="CAD">CAD ($)</option>
                <option value="AUD">AUD ($)</option>
            </select>
        </div>

        <div style="text-align: right; margin-top: 32px;">
            <button class="btn btn-primary" onclick="saveProfile()" id="save-profile-btn">Save Changes</button>
        </div>
    </div>

    <div class="card card-form">
        <h3>Account Status</h3>
        <div style="margin-top: 20px;">
            <div class="stat-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                <span style="color: var(--text-secondary);">Subscription Tier</span>
                <span style="font-weight: 600;" id="profile-tier">Free</span>
            </div>
            <div class="stat-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                <span style="color: var(--text-secondary);">Account Created</span>
                <span style="font-weight: 600;" id="profile-joined">...</span>
            </div>
            <div class="stat-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                <span style="color: var(--text-secondary);">Last Login</span>
                <span style="font-weight: 600;" id="profile-last-login">...</span>
            </div>
            <div class="stat-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                <span style="color: var(--text-secondary);">Email Status</span>
                <span style="font-weight: 600;" id="profile-email-status">...</span>
            </div>
            <div class="stat-row" style="display: flex; justify-content: space-between; padding: 12px 0;">
                <span style="color: var(--text-secondary);">User ID</span>
                <span style="font-weight: 600; font-family: monospace; font-size: 12px;" id="profile-user-id">...</span>
            </div>
        </div>
        
        <div style="margin-top: 24px;">
            <a href="/settings" class="btn btn-secondary" style="width: 100%; text-align: center;">
                ‚öôÔ∏è Go to Settings
            </a>
        </div>
    </div>
</div>

{% include "components/modal.html" %}
{% endblock %}

{% block scripts %}
<script>
    const TIER_DISPLAY = {
        'freemium': 'Freemium',
        'payg': 'Pay-As-You-Go',
        'pro': 'Pro',
        'custom': 'Custom'
    };

    async function loadProfile() {
        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/auth/login';
                return;
            }

            // Load user profile
            const res = await fetch('/api/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                const user = await res.json();

                // Header Info
                const displayName = user.display_name || user.email.split('@')[0];
                document.getElementById('display-name').textContent = displayName;
                document.getElementById('display-email').textContent = user.email;
                document.getElementById('profile-display-name').value = user.display_name || '';

                // Avatar
                if (user.avatar_url) {
                    document.getElementById('profile-avatar').src = user.avatar_url;
                } else {
                    document.getElementById('profile-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=random&size=200`;
                }

                // Email verification badge
                if (user.email_verified) {
                    document.getElementById('email-verified-badge').style.display = 'inline-block';
                    document.getElementById('profile-email-status').innerHTML = '<span style="color: #10b981;">‚úì Verified</span>';
                } else {
                    document.getElementById('profile-email-status').innerHTML = '<span style="color: #f59e0b;">Pending</span>';
                }

                // Form Info
                document.getElementById('profile-email-input').value = user.email;
                if (user.language) document.getElementById('profile-language').value = user.language;
                if (user.currency) document.getElementById('profile-currency').value = user.currency;

                // Stats
                const tier = user.subscription_tier || 'freemium';
                document.getElementById('profile-tier').textContent = TIER_DISPLAY[tier] || tier;
                document.getElementById('tier-badge').textContent = TIER_DISPLAY[tier] || tier;
                document.getElementById('tier-badge').className = `tier-badge-profile tier-badge-${tier}`;
                
                const createdDate = new Date(user.created_at);
                document.getElementById('profile-joined').textContent = createdDate.toLocaleDateString();
                document.getElementById('member-since').textContent = createdDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                document.getElementById('profile-user-id').textContent = user.id?.substring(0, 8) + '...';
                
                if (user.last_login) {
                    document.getElementById('profile-last-login').textContent = new Date(user.last_login).toLocaleDateString();
                } else {
                    document.getElementById('profile-last-login').textContent = "Just now";
                }
            }

            // Load verification stats
            await loadVerificationStats();
            
            // Load balance
            await loadBalance();

        } catch (e) {
            console.error("Profile load error:", e);
        }
    }

    async function loadVerificationStats() {
        const token = localStorage.getItem('access_token');
        try {
            const res = await fetch('/api/analytics/summary', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (res.ok) {
                const data = await res.json();
                document.getElementById('stat-total').textContent = data.total_verifications || 0;
                document.getElementById('stat-success').textContent = data.successful_verifications || 0;
                document.getElementById('stat-month').textContent = data.verifications_this_month || 0;
            }
        } catch (e) {
            console.error("Stats load error:", e);
        }
    }

    async function loadBalance() {
        const token = localStorage.getItem('access_token');
        try {
            const res = await fetch('/api/billing/balance', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (res.ok) {
                const data = await res.json();
                const balance = data.balance || data.credits || 0;
                document.getElementById('stat-balance').textContent = `$${parseFloat(balance).toFixed(2)}`;
            }
        } catch (e) {
            console.error("Balance load error:", e);
        }
    }

    function triggerAvatarUpload() {
        document.getElementById('avatar-upload').click();
    }

    async function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('Image size must be less than 2MB');
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }

        // Preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profile-avatar').src = e.target.result;
        };
        reader.readAsDataURL(file);

        // Upload to server (if endpoint exists)
        const token = localStorage.getItem('access_token');
        const formData = new FormData();
        formData.append('avatar', file);

        try {
            const res = await fetch('/api/user/avatar', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (res.ok) {
                const data = await res.json();
                if (data.avatar_url) {
                    document.getElementById('profile-avatar').src = data.avatar_url;
                }
            } else {
                // Endpoint might not exist yet, that's okay - preview still works
                console.log('Avatar upload endpoint not available');
            }
        } catch (e) {
            console.log('Avatar upload failed, using local preview');
        }
    }

    async function saveProfile() {
        const displayName = document.getElementById('profile-display-name').value;
        const lang = document.getElementById('profile-language').value;
        const curr = document.getElementById('profile-currency').value;
        const token = localStorage.getItem('access_token');

        const btn = document.getElementById('save-profile-btn');
        const originalText = btn.textContent;
        btn.textContent = "Saving...";
        btn.disabled = true;

        try {
            // Save to user settings
            const res = await fetch('/api/user/settings', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    display_name: displayName,
                    language: lang,
                    currency: curr
                })
            });

            if (res.ok) {
                // Update localStorage for language
                localStorage.setItem('language', lang);
                localStorage.setItem('currency', curr);
                
                // Update display name in header
                if (displayName) {
                    document.getElementById('display-name').textContent = displayName;
                }
                
                alert("Profile saved successfully!");
            } else {
                alert("Failed to save profile. Please try again.");
            }
        } catch (e) {
            console.error("Save profile error:", e);
            alert("Error saving profile.");
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    // Keyboard support for avatar
    document.querySelector('.avatar-container')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            triggerAvatarUpload();
        }
    });

    document.addEventListener('DOMContentLoaded', loadProfile);
</script>
{% endblock %}