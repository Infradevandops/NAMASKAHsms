{% extends "public_base.html" %}

{% block page_title %}Login{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
    .auth-container {
        max-width: 400px;
        margin: 40px auto;
        background: white;
        padding: 32px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .auth-title {
        font-size: 24px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 8px;
        color: #1a1a1a;
    }

    .auth-subtitle {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-bottom: 32px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: #333;
    }

    .form-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        transition: border-color 0.2s;
    }

    .form-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    .btn-auth {
        width: 100%;
        background: var(--primary);
        color: white;
        border: none;
        padding: 14px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.1s;
    }

    .btn-auth:active {
        transform: scale(0.98);
    }

    .auth-footer {
        text-align: center;
        margin-top: 24px;
        font-size: 14px;
        color: #666;
    }

    .auth-footer a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
    }

    .error-msg {
        background: #fff0f0;
        color: #e02b2b;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 14px;
        display: none;
    }
</style>
{% endblock %}

{% block public_content %}
<div class="auth-container">
    <h1 class="auth-title">Welcome Back</h1>
    <p class="auth-subtitle">Sign in to continue to your dashboard</p>

    <div id="error-message" class="error-msg"></div>

    <form id="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
            <label class="form-label">Email Address</label>
            <input type="email" class="form-input" id="email" required placeholder="name@example.com">
        </div>

        <div class="form-group">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <label class="form-label" style="margin: 0;">Password</label>
                <a href="/auth/forgot-password"
                    style="font-size: 12px; color: var(--primary); text-decoration: none;">Forgot password?</a>
            </div>
            <input type="password" class="form-input" id="password" required placeholder="Enter your password">
        </div>

        <button type="submit" class="btn-auth" id="login-btn">Sign In</button>
    </form>

    <div class="auth-footer">
        Don't have an account? <a href="/auth/register">Sign Up</a>
    </div>
</div>

<script>
    async function handleLogin(e) {
        e.preventDefault();
        const btn = document.getElementById('login-btn');
        const errorDiv = document.getElementById('error-message');

        btn.textContent = "Signing in...";
        btn.disabled = true;
        errorDiv.style.display = 'none';

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            // Since backend uses OAuth2PasswordRequestForm usually, check if it accepts JSON or form-data
            // Standard FastAPI OAuth2 expects form-data.
            // Let's assume JSON first as per previous tests seeing JSON bodies. 
            // Wait, standard `tokenUrl` usually implies form-data.
            // I'll try form-urlencoded first to be safe for OAuth2 compliant backends.

            const formData = new URLSearchParams();
            formData.append('username', email); // OAuth2 expects username
            formData.append('password', password);

            const res = await fetch('/api/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });

            // If that fails (404/422), try generic /api/auth/login with JSON
            if (res.status === 404 || res.status === 405) {
                const resJson = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                await processLoginResponse(resJson);
            } else {
                await processLoginResponse(res);
            }
        } catch (err) {
            showError("Connection error. Please try again.");
            btn.disabled = false;
            btn.textContent = "Sign In";
        }
    }

    async function processLoginResponse(res) {
        const btn = document.getElementById('login-btn');
        if (res.ok) {
            const data = await res.json();
            localStorage.setItem('access_token', data.access_token);
            // Add refreshing capability or expiration handling if needed
            window.location.href = '/dashboard';
        } else {
            const data = await res.json();
            showError(data.detail || "Invalid credentials");
            btn.disabled = false;
            btn.textContent = "Sign In";
        }
    }

    function showError(msg) {
        const el = document.getElementById('error-message');
        el.textContent = msg;
        el.style.display = 'block';
    }
</script>
{% endblock %}