{% extends "dashboard_base.html" %}

{% block page_title %}<span data-i18n="status.title">Service Status</span>{% endblock %}
{% block page_subtitle %}<span data-i18n="status.subtitle">Real-time provider health and uptime</span>{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
    .status-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .status-card {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 20px;
        border: 1px solid var(--border-color);
        text-align: center;
    }

    .status-card-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .status-card-label {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .provider-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
    }

    .provider-card {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 20px;
        border: 1px solid var(--border-color);
    }

    .provider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .provider-name {
        font-weight: 600;
        font-size: 16px;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-operational {
        background: #d5f4e6;
        color: #166534;
    }

    .status-degraded {
        background: #fef3c7;
        color: #92400e;
    }

    .status-down {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-unknown {
        background: #e5e7eb;
        color: #6b7280;
    }

    .provider-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }

    .metric {
        text-align: center;
    }

    .metric-value {
        font-size: 18px;
        font-weight: 600;
    }

    .metric-label {
        font-size: 11px;
        color: var(--text-muted);
    }

    .uptime-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .uptime-fill {
        height: 100%;
        background: #10b981;
        border-radius: 4px;
        transition: width 0.3s;
    }

    .incident-list {
        margin-top: 24px;
    }

    .incident-item {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .incident-item:last-child {
        border-bottom: none;
    }

    .incident-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .incident-title {
        font-weight: 600;
    }

    .incident-time {
        font-size: 12px;
        color: var(--text-muted);
    }

    .incident-description {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .auto-refresh-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .toggle-switch {
        position: relative;
        width: 40px;
        height: 20px;
        background: #e5e7eb;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .toggle-switch.active {
        background: var(--primary);
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.2s;
    }

    .toggle-switch.active::after {
        transform: translateX(20px);
    }

    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header with auto-refresh toggle -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div>
        <span id="last-updated" style="font-size: 14px; color: var(--text-muted);">Last updated: --</span>
    </div>
    <div class="auto-refresh-toggle">
        <span>Auto-refresh</span>
        <div id="auto-refresh-toggle" class="toggle-switch active" onclick="toggleAutoRefresh()" role="switch" aria-checked="true" tabindex="0"></div>
    </div>
</div>

<!-- Summary Cards -->
<div class="status-summary">
    <div class="status-card">
        <div class="status-card-value" id="total-providers" style="color: var(--primary);">--</div>
        <div class="status-card-label">Total Providers</div>
    </div>
    <div class="status-card">
        <div class="status-card-value" id="operational-count" style="color: #10b981;">--</div>
        <div class="status-card-label">Operational</div>
    </div>
    <div class="status-card">
        <div class="status-card-value" id="degraded-count" style="color: #f59e0b;">--</div>
        <div class="status-card-label">Degraded</div>
    </div>
    <div class="status-card">
        <div class="status-card-value" id="down-count" style="color: #ef4444;">--</div>
        <div class="status-card-label">Down</div>
    </div>
</div>

<!-- Provider Cards -->
<div class="provider-grid" id="provider-grid">
    <!-- Loading skeletons -->
    <div class="provider-card">
        <div class="loading-skeleton" style="height: 24px; width: 60%; margin-bottom: 16px;"></div>
        <div class="loading-skeleton" style="height: 60px; margin-bottom: 16px;"></div>
        <div class="loading-skeleton" style="height: 8px;"></div>
    </div>
    <div class="provider-card">
        <div class="loading-skeleton" style="height: 24px; width: 60%; margin-bottom: 16px;"></div>
        <div class="loading-skeleton" style="height: 60px; margin-bottom: 16px;"></div>
        <div class="loading-skeleton" style="height: 8px;"></div>
    </div>
</div>

<!-- Incident History -->
<div class="card incident-list" style="margin-top: 24px;">
    <h3 style="margin-bottom: 16px;">Recent Incidents</h3>
    <div id="incident-list">
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            Loading incidents...
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let autoRefreshEnabled = true;
    let refreshInterval = null;
    let providerData = [];

    async function loadProviderStatus() {
        const token = localStorage.getItem('access_token');
        
        try {
            const res = await fetch('/api/providers/health', {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });

            if (res.ok) {
                const data = await res.json();
                providerData = data.providers || [];
                renderProviders(providerData);
                updateSummary(providerData);
                updateLastUpdated();
            } else {
                showError('Failed to load provider status');
            }
        } catch (error) {
            console.error('Provider status error:', error);
            showError('Error loading provider status');
        }
    }

    function renderProviders(providers) {
        const grid = document.getElementById('provider-grid');
        
        if (providers.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 16px;">üì°</div>
                    <div>No provider data available</div>
                </div>
            `;
            return;
        }

        grid.innerHTML = providers.map(provider => {
            const statusClass = getStatusClass(provider.status);
            const statusText = getStatusText(provider.status);
            const uptime = provider.uptime_percent || 100;
            const responseTime = provider.response_time_ms || 0;
            const successRate = provider.success_rate || 100;

            return `
                <div class="provider-card">
                    <div class="provider-header">
                        <span class="provider-name">${escapeHtml(provider.name || provider.provider_id)}</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="provider-metrics">
                        <div class="metric">
                            <div class="metric-value">${responseTime}ms</div>
                            <div class="metric-label">Response Time</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${successRate.toFixed(1)}%</div>
                            <div class="metric-label">Success Rate</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${uptime.toFixed(1)}%</div>
                            <div class="metric-label">Uptime (30d)</div>
                        </div>
                    </div>
                    <div class="uptime-bar">
                        <div class="uptime-fill" style="width: ${uptime}%; background: ${getUptimeColor(uptime)};"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateSummary(providers) {
        const total = providers.length;
        const operational = providers.filter(p => p.status === 'operational').length;
        const degraded = providers.filter(p => p.status === 'degraded').length;
        const down = providers.filter(p => p.status === 'down').length;

        document.getElementById('total-providers').textContent = total;
        document.getElementById('operational-count').textContent = operational;
        document.getElementById('degraded-count').textContent = degraded;
        document.getElementById('down-count').textContent = down;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'operational': return 'status-operational';
            case 'degraded': return 'status-degraded';
            case 'down': return 'status-down';
            default: return 'status-unknown';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'operational': return 'Operational';
            case 'degraded': return 'Degraded';
            case 'down': return 'Down';
            default: return 'Unknown';
        }
    }

    function getUptimeColor(uptime) {
        if (uptime >= 99) return '#10b981';
        if (uptime >= 95) return '#f59e0b';
        return '#ef4444';
    }

    function updateLastUpdated() {
        const now = new Date();
        document.getElementById('last-updated').textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }

    function showError(message) {
        const grid = document.getElementById('provider-grid');
        grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-muted);">
                <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                <div>${escapeHtml(message)}</div>
                <button onclick="loadProviderStatus()" class="btn" style="margin-top: 16px;">Retry</button>
            </div>
        `;
    }

    async function loadIncidents() {
        const container = document.getElementById('incident-list');
        
        // Mock incidents for now - would come from /api/providers/incidents
        const incidents = [
            {
                title: 'All Systems Operational',
                time: new Date().toISOString(),
                description: 'No incidents reported in the last 30 days.',
                status: 'resolved'
            }
        ];

        if (incidents.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
                    <div>No incidents reported</div>
                </div>
            `;
            return;
        }

        container.innerHTML = incidents.map(incident => `
            <div class="incident-item">
                <div class="incident-header">
                    <span class="incident-title">${escapeHtml(incident.title)}</span>
                    <span class="incident-time">${new Date(incident.time).toLocaleDateString()}</span>
                </div>
                <div class="incident-description">${escapeHtml(incident.description)}</div>
            </div>
        `).join('');
    }

    function toggleAutoRefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        const toggle = document.getElementById('auto-refresh-toggle');
        toggle.classList.toggle('active', autoRefreshEnabled);
        toggle.setAttribute('aria-checked', autoRefreshEnabled);

        if (autoRefreshEnabled) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    }

    function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(loadProviderStatus, 30000);
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadProviderStatus();
        loadIncidents();
        startAutoRefresh();
    });

    // Keyboard support for toggle
    document.getElementById('auto-refresh-toggle')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleAutoRefresh();
        }
    });
</script>
{% endblock %}
