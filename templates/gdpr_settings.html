<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy & Data - Namaskah</title>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text: #f8fafc;
            --border: #475569;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, var(--primary), #4f46e5);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
        }
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .danger-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .info-box {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .data-item {
            background: #334155;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-label { font-weight: 600; }
        .data-value { opacity: 0.8; font-size: 14px; }
        .checkbox-group {
            margin: 16px 0;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Privacy & Data Management</h1>
            <p>Manage your personal data and privacy settings</p>
        </div>

        <div class="card">
            <h2>üìä Data Export (GDPR)</h2>
            <div class="info-box">
                <h3>üõ°Ô∏è Your Data Rights</h3>
                <p>Under GDPR, you have the right to receive a copy of all personal data we hold about you. This includes:</p>
                <ul style="margin: 12px 0 0 20px;">
                    <li>Account information and settings</li>
                    <li>SMS verification history</li>
                    <li>Transaction and billing records</li>
                    <li>Activity logs and audit trails</li>
                </ul>
            </div>
            
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="include-verifications" checked>
                    Include SMS verification history
                </label>
                <label>
                    <input type="checkbox" id="include-transactions" checked>
                    Include transaction history
                </label>
                <label>
                    <input type="checkbox" id="include-logs" checked>
                    Include activity logs
                </label>
            </div>

            <button class="btn btn-primary" onclick="exportData()" style="width: 100%;">
                üì• Download My Data (JSON Format)
            </button>
        </div>

        <div class="card">
            <h2>üìã Current Data Summary</h2>
            <div id="data-summary">
                <div style="text-align: center; padding: 20px; opacity: 0.7;">
                    Loading data summary...
                </div>
            </div>
        </div>

        <div class="card">
            <h2>‚ö†Ô∏è Account Deletion</h2>
            <div class="danger-box">
                <h3>üö® Permanent Account Deletion</h3>
                <p><strong>Warning:</strong> This action is irreversible and will permanently delete:</p>
                <ul style="margin: 12px 0 0 20px;">
                    <li>Your account and all personal information</li>
                    <li>All SMS verification history</li>
                    <li>Transaction and billing records</li>
                    <li>Any remaining account balance</li>
                    <li>All associated data and logs</li>
                </ul>
                <p style="margin-top: 12px;"><strong>This cannot be undone.</strong></p>
            </div>

            <div class="warning-box">
                <h3>üìù Before You Delete</h3>
                <p>Please consider:</p>
                <ul style="margin: 8px 0 0 20px;">
                    <li>Export your data first if you need it</li>
                    <li>Cancel any active phone rentals</li>
                    <li>Use any remaining account balance</li>
                    <li>Contact support if you have questions</li>
                </ul>
            </div>

            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="confirm-deletion">
                    I understand this action is permanent and irreversible
                </label>
                <label>
                    <input type="checkbox" id="confirm-data-loss">
                    I understand all my data will be permanently deleted
                </label>
                <label>
                    <input type="checkbox" id="confirm-balance-loss">
                    I understand any remaining balance will be lost
                </label>
            </div>

            <button class="btn btn-danger" onclick="deleteAccount()" style="width: 100%;" id="delete-btn" disabled>
                üóëÔ∏è Permanently Delete My Account
            </button>
        </div>

        <div class="card">
            <h2>üìû Need Help?</h2>
            <p>If you have questions about your data or privacy:</p>
            <ul style="margin: 12px 0 0 20px;">
                <li>üìß Email: privacy@namaskah.app</li>
                <li>üí¨ Live chat support</li>
                <li>üìö Privacy Policy: <a href="/privacy" style="color: var(--primary);">/privacy</a></li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadDataSummary();
            setupDeletionConfirmation();
        });

        async function loadDataSummary() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/gdpr/export', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                displayDataSummary(data);
            } catch (error) {
                console.error('Load data summary error:', error);
                document.getElementById('data-summary').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--danger);">
                        Failed to load data summary
                    </div>
                `;
            }
        }

        function displayDataSummary(data) {
            const container = document.getElementById('data-summary');
            
            container.innerHTML = `
                <div class="data-item">
                    <div>
                        <div class="data-label">Account Information</div>
                        <div class="data-value">Email, settings, preferences</div>
                    </div>
                    <div style="color: var(--primary); font-weight: 600;">1 record</div>
                </div>
                <div class="data-item">
                    <div>
                        <div class="data-label">SMS Verifications</div>
                        <div class="data-value">Verification history and codes</div>
                    </div>
                    <div style="color: var(--primary); font-weight: 600;">${data.verifications?.length || 0} records</div>
                </div>
                <div class="data-item">
                    <div>
                        <div class="data-label">Activity Logs</div>
                        <div class="data-value">Login history and actions</div>
                    </div>
                    <div style="color: var(--primary); font-weight: 600;">${data.audit_logs?.length || 0} records</div>
                </div>
                <div class="data-item">
                    <div>
                        <div class="data-label">Account Created</div>
                        <div class="data-value">Registration date</div>
                    </div>
                    <div style="color: var(--secondary); font-weight: 600;">${formatDate(data.user?.created_at)}</div>
                </div>
            `;
        }

        async function exportData() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/gdpr/export', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                // Create and download JSON file
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `namaskah-data-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('Data export downloaded successfully!', 'success');
            } catch (error) {
                console.error('Export data error:', error);
                showAlert('Failed to export data', 'error');
            }
        }

        function setupDeletionConfirmation() {
            const checkboxes = ['confirm-deletion', 'confirm-data-loss', 'confirm-balance-loss'];
            const deleteBtn = document.getElementById('delete-btn');
            
            checkboxes.forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    const allChecked = checkboxes.every(checkboxId => 
                        document.getElementById(checkboxId).checked
                    );
                    deleteBtn.disabled = !allChecked;
                });
            });
        }

        async function deleteAccount() {
            const finalConfirm = prompt(
                'This will PERMANENTLY delete your account and ALL data.\\n\\n' +
                'Type "DELETE MY ACCOUNT" to confirm:'
            );
            
            if (finalConfirm !== 'DELETE MY ACCOUNT') {
                showAlert('Account deletion cancelled', 'warning');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/gdpr/account', {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Account deleted successfully', 'success');
                    localStorage.clear();
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    showAlert(data.detail || 'Failed to delete account', 'error');
                }
            } catch (error) {
                console.error('Delete account error:', error);
                showAlert('Failed to delete account', 'error');
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            return date.toLocaleDateString();
        }

        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                background: ${type === 'success' ? 'var(--secondary)' : type === 'warning' ? 'var(--warning)' : 'var(--danger)'};
                color: white; padding: 12px 20px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            alert.textContent = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
    </script>
</body>
</html>