{% extends "dashboard_base.html" %}

{% block page_title %}Webhooks{% endblock %}
{% block page_subtitle %}Manage your real-time data integrations{% endblock %}

{% block head_extra %}
{{ super() }}
<link rel="stylesheet" href="/static/css/loading-animations.css">
<style>
    .webhook-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
        margin-bottom: 32px;
    }

    .webhook-card {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 24px;
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-color);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .webhook-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    .webhook-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .webhook-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .webhook-url {
        font-family: monospace;
        font-size: 14px;
        color: var(--text-secondary);
        background: var(--bg-body);
        padding: 4px 8px;
        border-radius: 4px;
        word-break: break-all;
    }

    .webhook-badge {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 500;
    }

    .badge-active {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .badge-inactive {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .webhook-events {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 16px 0;
    }

    .event-tag {
        font-size: 11px;
        background: var(--bg-body);
        color: var(--text-muted);
        padding: 2px 8px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .webhook-info {
        display: flex;
        gap: 24px;
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .webhook-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .secret-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        font-size: 13px;
    }

    .secret-value {
        font-family: monospace;
        color: var(--primary);
        filter: blur(4px);
        transition: filter 0.3s;
        cursor: pointer;
    }

    .secret-value:hover {
        filter: blur(0);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 32px;
        width: 100%;
        max-width: 500px;
        box-shadow: var(--shadow-extra);
    }

    .event-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
    }

    .event-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <div>
        <h1 style="margin: 0;">Webhook Builder</h1>
        <p style="color: var(--text-muted); margin: 4px 0 0 0;">Build custom real-time integrations for your business
        </p>
    </div>
    <button class="btn btn-primary" onclick="showAddModal()">
        <i class="ph ph-plus"></i> Add Webhook
    </button>
</div>

<div id="webhooks-container" class="webhook-grid">
    <div style="text-align: center; padding: 60px;">
        <span class="loading-spinner"></span> Loading your webhooks...
    </div>
</div>

<div id="empty-state" style="display: none; text-align: center; padding: 80px 20px;">
    <div style="font-size: 64px; margin-bottom: 24px;">ðŸ”—</div>
    <h2>No Webhooks Configured</h2>
    <p style="color: var(--text-muted); max-width: 400px; margin: 12px auto;">
        Connect your apps to Namaskah and receive real-time updates for SMS, orders, and more.
    </p>
    <button class="btn btn-primary" onclick="showAddModal()" style="margin-top: 24px;">
        Create First Webhook
    </button>
</div>

<!-- Add Webhook Modal -->
<div id="add-modal" class="modal">
    <div class="modal-content">
        <h2 style="margin: 0 0 24px 0;">New Webhook</h2>
        <div class="form-group">
            <label class="form-label">Webhook Name</label>
            <input type="text" id="webhook-name" class="form-input" placeholder="e.g., Production Server">
        </div>
        <div class="form-group">
            <label class="form-label">Payload URL</label>
            <input type="url" id="webhook-url" class="form-input" placeholder="https://your-api.com/webhooks">
        </div>
        <div class="form-group">
            <label class="form-label">Events to trigger</label>
            <div class="event-selector">
                <label class="event-checkbox">
                    <input type="checkbox" value="sms.received" checked> SMS Received
                </label>
                <label class="event-checkbox">
                    <input type="checkbox" value="order.updated" checked> Order Updated
                </label>
                <label class="event-checkbox">
                    <input type="checkbox" value="payment.success" checked> Payment Success
                </label>
                <label class="event-checkbox">
                    <input type="checkbox" value="system.alert"> System Alerts
                </label>
            </div>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 32px;">
            <button class="btn btn-secondary" onclick="hideAddModal()" style="flex: 1;">Cancel</button>
            <button class="btn btn-primary" onclick="createWebhook()" id="create-btn" style="flex: 1;">Create
                Webhook</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="/static/js/api-retry.js"></script>
<script>
    async function loadWebhooks() {
        const container = document.getElementById('webhooks-container');
        const emptyState = document.getElementById('empty-state');
        const token = localStorage.getItem('access_token');

        try {
            const response = await ApiRetry.fetchWithRetry('/api/webhooks', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to load webhooks');

            const result = await response.json();
            const webhooks = result.data || [];

            if (webhooks.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'grid';

            container.innerHTML = webhooks.map(w => `
                <div class="webhook-card">
                    <div class="webhook-header">
                        <div>
                            <div class="webhook-name">${escapeHtml(w.name)}</div>
                            <div class="webhook-url">${escapeHtml(w.url)}</div>
                        </div>
                        <span class="webhook-badge ${w.is_active ? 'badge-active' : 'badge-inactive'}">
                            ${w.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    
                    <div class="webhook-events">
                        ${(w.events || '*').split(',').map(e => `<span class="event-tag">${e.trim()}</span>`).join('')}
                    </div>
                    
                    <div class="secret-container">
                        <span style="color: var(--text-muted);">Signing Secret:</span>
                        <span class="secret-value" title="Click to copy" onclick="copyToClipboard('${w.secret}')">${w.secret}</span>
                    </div>
                    
                    <div class="webhook-info">
                        <div class="info-item">
                            <i class="ph ph-check-circle"></i>
                            Last Success: ${w.last_success ? formatRelative(w.last_success) : 'Never'}
                        </div>
                        <div class="info-item">
                            <i class="ph ph-warning-circle"></i>
                            Last Failure: ${w.last_failure ? formatRelative(w.last_failure) : 'None'}
                        </div>
                    </div>
                    
                    <div class="webhook-actions">
                        <button class="btn btn-secondary" onclick="testWebhook('${w.id}')">Test Ping</button>
                        <button class="btn btn-secondary" style="color: #ef4444;" onclick="deleteWebhook('${w.id}')">Delete</button>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 40px;">${error.message}</div>`;
        }
    }

    async function createWebhook() {
        const name = document.getElementById('webhook-name').value;
        const url = document.getElementById('webhook-url').value;
        const events = Array.from(document.querySelectorAll('.event-checkbox input:checked')).map(i => i.value);
        const btn = document.getElementById('create-btn');
        const token = localStorage.getItem('access_token');

        if (!name || !url) return alert('Name and URL are required');

        try {
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Creating...';

            const response = await fetch('/api/webhooks', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, url, events })
            });

            if (!response.ok) throw new Error('Failed to create webhook');

            hideAddModal();
            loadWebhooks();

        } catch (error) {
            alert(error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Create Webhook';
        }
    }

    async function deleteWebhook(id) {
        if (!confirm('Are you sure you want to delete this webhook?')) return;
        const token = localStorage.getItem('access_token');

        try {
            const response = await fetch(`/api/webhooks/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) loadWebhooks();
        } catch (error) {
            alert('Deletion failed');
        }
    }

    async function testWebhook(id) {
        const token = localStorage.getItem('access_token');
        try {
            const response = await fetch(`/api/webhooks/${id}/test`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await response.json();
            alert(result.message);
        } catch (error) {
            alert('Test failed');
        }
    }

    function showAddModal() { document.getElementById('add-modal').style.display = 'flex'; }
    function hideAddModal() { document.getElementById('add-modal').style.display = 'none'; }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatRelative(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString();
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        alert('Secret copied to clipboard');
    }

    document.addEventListener('DOMContentLoaded', loadWebhooks);
</script>
{% endblock %}