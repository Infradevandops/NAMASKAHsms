{% extends "dashboard_base.html" %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Overview of your SMS verification activity{% endblock %}

{% block content %}
<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 40px;">
    <div class="card">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Total SMS</div>
        <div style="font-size: 32px; font-weight: 700;" id="total-sms">0</div>
    </div>
    <div class="card">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Successful</div>
        <div style="font-size: 32px; font-weight: 700; color: #10b981;" id="successful-sms">0</div>
    </div>
    <div class="card">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Total Spent</div>
        <div style="font-size: 32px; font-weight: 700;" id="total-spent">$0.00</div>
    </div>
    <div class="card">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Success Rate</div>
        <div style="font-size: 32px; font-weight: 700;" id="success-rate">0%</div>
    </div>
</div>

<div class="card">
    <h3 style="font-size: 18px; margin-bottom: 16px;">Recent Activity</h3>
    <div id="empty-state" style="text-align: center; padding: 40px; color: var(--text-muted); display: none;">
        <div style="font-size: 24px; margin-bottom: 12px;">No recent activity</div>
        <button class="btn" onclick="window.location.href='/verify'" style="margin-top: 16px;">Start Verification</button>
    </div>
    <table id="activity-table" style="width: 100%; border-collapse: collapse; display: none;">
        <thead>
            <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Service</th>
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Number</th>
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Time</th>
                <th style="text-align: left; padding: 12px; font-size: 14px; color: var(--text-muted);">Status</th>
            </tr>
        </thead>
        <tbody id="activity-body"></tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
async function loadAnalytics() {
    const token = localStorage.getItem('access_token');
    if (!token) return;
    
    try {
        const res = await fetch('/api/analytics/summary', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.ok) {
            const data = await res.json();
            document.getElementById('total-sms').textContent = data.total_verifications || 0;
            document.getElementById('successful-sms').textContent = data.successful_verifications || 0;
            document.getElementById('total-spent').textContent = `$${(data.revenue || 0).toFixed(2)}`;
            const rate = data.success_rate ? (data.success_rate * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = `${rate}%`;
        } else {
            // Set defaults on error
            document.getElementById('total-sms').textContent = '0';
            document.getElementById('successful-sms').textContent = '0';
            document.getElementById('total-spent').textContent = '$0.00';
            document.getElementById('success-rate').textContent = '0%';
        }
    } catch (error) {
        console.error('Analytics load failed:', error);
        // Set defaults on error
        document.getElementById('total-sms').textContent = '0';
        document.getElementById('successful-sms').textContent = '0';
        document.getElementById('total-spent').textContent = '$0.00';
        document.getElementById('success-rate').textContent = '0%';
    }
}

async function loadActivity() {
    const token = localStorage.getItem('access_token');
    if (!token) return;
    
    const tbody = document.getElementById('activity-body');
    const table = document.getElementById('activity-table');
    const emptyState = document.getElementById('empty-state');
    
    try {
        const res = await fetch('/api/dashboard/activity/recent', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.ok) {
            const data = await res.json();
            if (data.activities && data.activities.length > 0) {
                tbody.innerHTML = data.activities.map(a => `
                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                        <td style="padding: 12px;">${escapeHtml(a.service_name || 'N/A')}</td>
                        <td style="padding: 12px;">${escapeHtml(a.phone_number || 'N/A')}</td>
                        <td style="padding: 12px;">${new Date(a.created_at).toLocaleString()}</td>
                        <td style="padding: 12px;"><span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${a.status === 'completed' ? '#d5f4e6' : '#fef3c7'}; color: ${a.status === 'completed' ? '#166534' : '#92400e'};">${escapeHtml(a.status)}</span></td>
                    </tr>
                `).join('');
                table.style.display = 'table';
                emptyState.style.display = 'none';
            } else {
                table.style.display = 'none';
                emptyState.style.display = 'block';
            }
        } else {
            table.style.display = 'none';
            emptyState.style.display = 'block';
        }
    } catch (error) {
        console.error('Activity load failed:', error);
        table.style.display = 'none';
        emptyState.style.display = 'block';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load on page ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        loadAnalytics();
        loadActivity();
    });
} else {
    loadAnalytics();
    loadActivity();
}

// Auto-refresh every 30 seconds
setInterval(() => {
    loadAnalytics();
    loadActivity();
}, 30000);
</script>
{% endblock %}
