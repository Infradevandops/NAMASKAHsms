{"version":3,"file":"dashboard-init.BYB0MpFa.js","sources":["../../js/dashboard-init.js"],"sourcesContent":["/**\n * Dashboard Initialization Module\n * \n * Initializes all dashboard widgets:\n * - Tier Card\n * - Analytics Stats\n * - Recent Activity\n * \n * This module replaces the inline script in dashboard.html\n */\n\nimport { TIMEOUTS, ENDPOINTS, STORAGE_KEYS } from './constants.js';\nimport { hasAuthToken, getAuthHeaders } from './auth-helpers.ts';\nimport { initTierCard } from './tier-card.js';\n\n// ============================================\n// ANALYTICS WIDGET\n// ============================================\nclass AnalyticsWidget {\n    constructor() {\n        this.elements = {\n            totalSms: document.getElementById('total-sms'),\n            successfulSms: document.getElementById('successful-sms'),\n            totalSpent: document.getElementById('total-spent'),\n            successRate: document.getElementById('success-rate')\n        };\n    }\n\n    async load() {\n        if (!hasAuthToken()) return;\n\n        this._log('info', 'Loading analytics...');\n\n        try {\n            const response = await fetch(ENDPOINTS.ANALYTICS.SUMMARY, {\n                credentials: 'include',\n                headers: getAuthHeaders()\n            });\n\n            if (!response.ok) return;\n\n            const data = await response.json();\n            this._log('info', 'Analytics loaded', data);\n            this._render(data);\n\n        } catch (error) {\n            this._log('error', 'Analytics load failed', { error: error.message });\n        }\n    }\n\n    _render(data) {\n        if (this.elements.totalSms) {\n            this.elements.totalSms.textContent = data.total_verifications || 0;\n        }\n        if (this.elements.successfulSms) {\n            this.elements.successfulSms.textContent = data.successful_verifications || 0;\n        }\n        if (this.elements.totalSpent) {\n            const spent = data.revenue || data.total_spent || 0;\n            this.elements.totalSpent.textContent = `$${spent.toFixed(2)}`;\n            this.elements.totalSpent.setAttribute('data-amount', spent);\n        }\n        if (this.elements.successRate) {\n            const rate = data.success_rate || 0;\n            this.elements.successRate.textContent = `${rate.toFixed(1)}%`;\n        }\n    }\n\n    _log(level, message, data = null) {\n        if (window.FrontendLogger) {\n            window.FrontendLogger[level](message, data);\n        }\n    }\n}\n\n// ============================================\n// ACTIVITY WIDGET\n// ============================================\nclass ActivityWidget {\n    constructor() {\n        this.elements = {\n            loading: document.getElementById('activity-loading'),\n            table: document.getElementById('activity-table'),\n            empty: document.getElementById('empty-state'),\n            body: document.getElementById('activity-body')\n        };\n    }\n\n    async load() {\n        if (!hasAuthToken()) {\n            this._showEmpty();\n            return;\n        }\n\n        this._log('info', 'Loading recent activity...');\n\n        try {\n            const response = await fetch(ENDPOINTS.DASHBOARD.ACTIVITY, {\n                credentials: 'include',\n                headers: getAuthHeaders()\n            });\n\n            this._hideLoading();\n\n            if (!response.ok) {\n                this._showEmpty();\n                return;\n            }\n\n            const activities = await response.json();\n\n            if (!activities || activities.length === 0) {\n                this._showEmpty();\n                return;\n            }\n\n            this._log('info', `Activity loaded: ${activities.length} items`);\n            this._render(activities);\n\n        } catch (error) {\n            this._log('error', 'Activity load failed', { error: error.message });\n            this._hideLoading();\n            this._showEmpty();\n        }\n    }\n\n    _render(activities) {\n        let html = '';\n\n        for (const activity of activities) {\n            const statusColor = activity.status === 'completed' ? '#10b981'\n                : activity.status === 'failed' ? '#ef4444'\n                    : '#f59e0b';\n\n            html += `\n                <tr style=\"border-bottom: 1px solid rgba(0,0,0,0.05);\">\n                    <td style=\"padding: 12px;\">${this._escapeHtml(activity.service_name || 'Unknown')}</td>\n                    <td style=\"padding: 12px;\">${this._escapeHtml(activity.phone_number || '-')}</td>\n                    <td style=\"padding: 12px;\">${this._formatTime(activity.created_at)}</td>\n                    <td style=\"padding: 12px; color: ${statusColor};\">${this._escapeHtml(activity.status || 'pending')}</td>\n                </tr>\n            `;\n        }\n\n        if (this.elements.body) {\n            this.elements.body.innerHTML = html;\n        }\n        if (this.elements.table) {\n            this.elements.table.style.display = 'table';\n        }\n    }\n\n    _hideLoading() {\n        if (this.elements.loading) {\n            this.elements.loading.style.display = 'none';\n        }\n    }\n\n    _showEmpty() {\n        this._hideLoading();\n        if (this.elements.empty) {\n            this.elements.empty.style.display = 'block';\n        }\n    }\n\n    _escapeHtml(text) {\n        if (!text) return '';\n        const div = document.createElement('div');\n        div.textContent = text;\n        return div.innerHTML;\n    }\n\n    _formatTime(isoString) {\n        if (!isoString) return '-';\n        try {\n            return new Date(isoString).toLocaleString();\n        } catch (e) {\n            return isoString;\n        }\n    }\n\n    _log(level, message, data = null) {\n        if (window.FrontendLogger) {\n            window.FrontendLogger[level](message, data);\n        }\n    }\n}\n\n// ============================================\n// MODAL HANDLERS\n// ============================================\nfunction showComparePlansModal() {\n    const currentTier = window.tierCard?.currentData?.current_tier || 'freemium';\n    if (typeof window.showTierCompareModal === 'function') {\n        window.showTierCompareModal(currentTier);\n    }\n}\n\nfunction closeComparePlansModal() {\n    if (typeof window.closeTierCompareModal === 'function') {\n        window.closeTierCompareModal();\n    }\n}\n\n// ============================================\n// INITIALIZATION\n// ============================================\nfunction initDashboard() {\n    // Initialize Tier Card\n    const tierCard = initTierCard('tier-card');\n\n    // Initialize Analytics\n    const analytics = new AnalyticsWidget();\n    analytics.load();\n\n    // Initialize Activity\n    const activity = new ActivityWidget();\n    activity.load();\n\n    // Set up periodic refresh\n    setInterval(() => {\n        if (hasAuthToken()) {\n            tierCard.load();\n            analytics.load();\n        }\n    }, TIMEOUTS.REFRESH_INTERVAL);\n\n    // Expose modal handlers globally\n    window.showComparePlansModal = showComparePlansModal;\n    window.closeComparePlansModal = closeComparePlansModal;\n\n    return { tierCard, analytics, activity };\n}\n\n// Auto-initialize on DOM ready\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initDashboard);\n} else {\n    initDashboard();\n}\n\n// Export for external use\nexport { initDashboard, AnalyticsWidget, ActivityWidget };\n"],"names":["AnalyticsWidget","constructor","this","elements","totalSms","document","getElementById","successfulSms","totalSpent","successRate","load","hasAuthToken","_log","response","fetch","ENDPOINTS","ANALYTICS","SUMMARY","credentials","headers","getAuthHeaders","ok","data","json","_render","error","message","textContent","total_verifications","successful_verifications","spent","revenue","total_spent","toFixed","setAttribute","rate","success_rate","level","window","FrontendLogger","ActivityWidget","loading","table","empty","body","DASHBOARD","ACTIVITY","_hideLoading","_showEmpty","activities","length","html","activity","statusColor","status","_escapeHtml","service_name","phone_number","_formatTime","created_at","innerHTML","style","display","text","div","createElement","isoString","Date","toLocaleString","e","showComparePlansModal","currentTier","_b","_a","tierCard","currentData","current_tier","showTierCompareModal","closeComparePlansModal","closeTierCompareModal","initDashboard","initTierCard","analytics","setInterval","TIMEOUTS","REFRESH_INTERVAL","readyState","addEventListener"],"mappings":"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"}