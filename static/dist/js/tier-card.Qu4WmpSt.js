import{T as t,c as e,E as i,b as n,d as s,e as r,f as a,S as o}from"./constants.mniaqQLw.js";import{h as l,g as d}from"./auth-store.D23SS89P.js";class c{constructor(i,n={}){this.containerId=i,this.container=document.getElementById(i),this.container&&(this.timeout=n.timeout||t.API_REQUEST,this.failsafeTimeout=n.failsafeTimeout||t.FAILSAFE,this.refreshInterval=n.refreshInterval||t.REFRESH_INTERVAL,this.onStateChange=n.onStateChange||null,this.state=e.INITIAL,this.currentData=null,this.abortController=null,this.timeoutId=null,this.failsafeId=null,this.refreshIntervalId=null,this.elements={tierName:document.getElementById("tier-name"),tierPrice:document.getElementById("tier-price"),featuresList:document.getElementById("tier-features-list"),ctaButtons:{upgrade:document.getElementById("upgrade-btn"),compare:document.getElementById("compare-plans-btn"),addCredits:document.getElementById("add-credits-btn"),usage:document.getElementById("usage-btn"),manage:document.getElementById("manage-btn"),contact:document.getElementById("contact-btn")}},this.load=this.load.bind(this),this.retry=this.retry.bind(this))}init(){this.load(),this.startAutoRefresh(),this.setupFailsafe()}setupFailsafe(){this.failsafeId=setTimeout(()=>{this.state===e.LOADING&&(this._log("warn",`Failsafe triggered after ${this.failsafeTimeout}ms`),this.setState(e.TIMEOUT))},this.failsafeTimeout)}startAutoRefresh(){this.refreshIntervalId&&clearInterval(this.refreshIntervalId),this.refreshIntervalId=setInterval(()=>{l()&&this.load()},this.refreshInterval)}stopAutoRefresh(){this.refreshIntervalId&&(clearInterval(this.refreshIntervalId),this.refreshIntervalId=null)}async load(){if(this._log("info","Loading tier information..."),this._clearTimers(),!l())return this._log("warn","No auth token found"),void this.setState(e.UNAUTHENTICATED);this.setState(e.LOADING),this.abortController=new AbortController,this.timeoutId=setTimeout(()=>{this._log("warn",`Request timeout after ${this.timeout}ms`),this.abortController.abort(),this.setState(e.TIMEOUT)},this.timeout);try{this._log("info",`API Call: GET ${i.TIERS.CURRENT}`);const t=await fetch(i.TIERS.CURRENT,{credentials:"include",headers:d(),signal:this.abortController.signal});if(this._clearTimers(),this._log("info",`API Response: ${t.status}`),401===t.status)return this._log("warn","401 Unauthorized - session may have expired"),void this.setState(e.SESSION_EXPIRED);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const n=await t.json();this.currentData=n,this._cacheData(n),this._log("info","Tier loaded successfully",{tier:n.current_tier}),this.setState(e.LOADED,n)}catch(t){if(this._clearTimers(),"AbortError"===t.name)return;this._log("error","Tier load failed",{error:t.message});const i=this._getCachedData();if(i)return this._log("info","Using cached tier data as fallback"),this.setState(e.LOADED,i),void this._showCacheWarning();this.setState(e.ERROR,{message:t.message})}}retry(){this.load()}setState(t,i=null){switch(this.state=t,this.container.classList.remove("tier-card-loading","tier-card-error","tier-card-loaded"),this.container.setAttribute("aria-busy",t===e.LOADING?"true":"false"),t){case e.LOADING:this.container.classList.add("tier-card-loading"),this._renderLoading();break;case e.UNAUTHENTICATED:this.container.classList.add("tier-card-error"),this._renderUnauthenticated();break;case e.SESSION_EXPIRED:this.container.classList.add("tier-card-error"),this._renderSessionExpired();break;case e.TIMEOUT:this.container.classList.add("tier-card-error"),this._renderTimeout();break;case e.ERROR:this.container.classList.add("tier-card-error"),this._renderError(null==i?void 0:i.message);break;case e.LOADED:this.container.classList.add("tier-card-loaded"),this._renderLoaded(i)}this.onStateChange&&this.onStateChange(t,i)}_renderLoading(){this.elements.tierName.innerHTML='<span class="loading-spinner"></span> Loading...',this.elements.tierPrice.textContent="",this.elements.featuresList.innerHTML="",this._hideAllCTAs()}_renderUnauthenticated(){this.elements.tierName.innerHTML="üîí Not logged in",this.elements.tierPrice.textContent="",this.elements.featuresList.innerHTML='\n            <div style="margin-top: 12px;">\n                <a href="/auth/login" class="btn btn-primary" aria-label="Log in to view your subscription plan">\n                    Log in to view your plan\n                </a>\n            </div>\n        ',this._hideAllCTAs()}_renderSessionExpired(){this.elements.tierName.innerHTML="üîê Session expired",this.elements.tierPrice.textContent="",this.elements.featuresList.innerHTML='\n            <div style="margin-top: 12px;">\n                <a href="/auth/login" class="btn btn-primary" aria-label="Log in again to continue">\n                    Log in again\n                </a>\n            </div>\n        ',this._hideAllCTAs()}_renderTimeout(){this.elements.tierName.innerHTML="‚è±Ô∏è Request timed out",this.elements.tierPrice.textContent="",this.elements.featuresList.innerHTML='\n            <div style="color: var(--text-muted); margin-bottom: 12px;">\n                The server took too long to respond.\n            </div>\n            <button class="btn btn-secondary" onclick="window.tierCard?.retry()" aria-label="Try loading tier information again">\n                üîÑ Try again\n            </button>\n        ',this._hideAllCTAs()}_renderError(t){const e=t||"Unable to load plan information";this.elements.tierName.innerHTML="‚ö†Ô∏è Error",this.elements.tierPrice.textContent="",this.elements.featuresList.innerHTML=`\n            <div style="color: var(--text-muted); margin-bottom: 12px;">\n                ${this._escapeHtml(e)}\n            </div>\n            <button class="btn btn-secondary" onclick="window.tierCard?.retry()" aria-label="Retry loading tier information">\n                üîÑ Retry\n            </button>\n        `,this.elements.ctaButtons.upgrade&&(this.elements.ctaButtons.upgrade.style.display="inline-flex")}_renderLoaded(t){const e=t.current_tier||"freemium",i=n[e]||"Unknown",a=s[e]||"";this.elements.tierName.innerHTML=`\n            <span class="tier-badge ${a}" style="font-size: 18px; padding: 6px 16px;">\n                ${i}\n            </span>\n        `,void 0!==t.price_monthly&&(this.elements.tierPrice.textContent=0===t.price_monthly?"Free":`$${t.price_monthly}/month`);const o=r[e]||[{text:"Basic features included",available:!0}];let l="";for(const n of o){const t=n.available?"‚úì":"‚úó";l+=`<div style="margin-bottom: 4px; ${n.available?"color: var(--tier-freemium);":"color: var(--text-muted);"}">${t} ${n.text}</div>`}t.quota_usd>0&&(l+=`<div style="margin-bottom: 4px; color: var(--tier-freemium);">‚úì $${t.quota_usd} monthly quota</div>`),this.elements.featuresList.innerHTML=l,this._renderCTAs(e),this._updateQuotaDisplay(e,t)}_renderCTAs(t){const e=a[t]||a.freemium;this._hideAllCTAs();for(const i of e){const e=this.elements.ctaButtons[i.id.replace("-btn","").replace("compare-plans","compare").replace("add-credits","addCredits")];e&&(e.style.display="inline-flex",e.className=`btn btn-${i.variant}`,e.textContent=i.label,e.setAttribute("aria-label",`${i.label} - ${n[t]} tier action`),i.href?e.onclick=()=>{window.location.href=i.href}:i.action&&"function"==typeof window[i.action]&&(e.onclick=()=>{window[i.action]()}))}}_hideAllCTAs(){for(const t of Object.values(this.elements.ctaButtons))t&&(t.style.display="none")}_updateQuotaDisplay(t,e){var i;const n=document.getElementById("quota-card"),s=document.getElementById("api-stats-card");if("freemium"!==t&&e.quota_usd>0&&n){n.style.display="block";const t=e.quota_used_usd||0,i=e.quota_usd||0,s=i>0?Math.min(t/i*100,100):0,r=document.getElementById("quota-fill"),a=document.getElementById("quota-text");r&&(r.style.width=`${s}%`,r.style.background=s>=100?"#ef4444":s>80?"#f59e0b":"var(--primary)"),a&&(a.textContent=`$${t.toFixed(2)} / $${i.toFixed(2)}`)}if("freemium"!==t&&s){s.style.display="block";const t=document.getElementById("api-sms-count"),n=document.getElementById("api-calls-count"),r=document.getElementById("api-keys-count");t&&(t.textContent=e.sms_count||0),n&&(n.textContent=e.sms_count||0),r&&(r.textContent=(null==(i=e.features)?void 0:i.api_key_limit)||0)}}_showCacheWarning(){const t=document.createElement("div");t.style.cssText="color: var(--tier-pro); font-size: 12px; margin-top: 8px;",t.textContent="‚ö†Ô∏è Showing cached data",this.elements.featuresList.appendChild(t)}_cacheData(t){try{localStorage.setItem(o.CACHED_TIER,JSON.stringify(t))}catch(e){}}_getCachedData(){try{const t=localStorage.getItem(o.CACHED_TIER);return t?JSON.parse(t):null}catch(t){return null}}_clearTimers(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.failsafeId&&(clearTimeout(this.failsafeId),this.failsafeId=null)}_escapeHtml(t){if(!t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}_log(t,e,i=null){window.FrontendLogger&&window.FrontendLogger[t](e,i)}destroy(){this._clearTimers(),this.stopAutoRefresh(),this.abortController&&this.abortController.abort()}}function h(t="tier-card",e={}){const i=new c(t,e);return i.init(),window.tierCard=i,i}"undefined"!=typeof window&&(window.TierCard=c,window.initTierCard=h);export{h as i};
//# sourceMappingURL=tier-card.Qu4WmpSt.js.map
