{"version":3,"file":"dashboard-loader.DstIMoaK.js","sources":["../../js/dashboard-loader.js"],"sourcesContent":["/**\n * Dashboard Loader Utility\n * \n * Provides consistent loading, error handling, and timeout behavior\n * for all dashboard widgets. Prevents infinite spinners.\n * \n * Usage:\n *   const loader = new DashboardLoader({\n *       containerId: 'my-widget',\n *       loadingText: 'Loading data...',\n *       timeout: 10000,\n *       onLoad: async () => { return await fetchData(); },\n *       onSuccess: (data) => { renderWidget(data); },\n *       onError: (error) => { showError(error); }\n *   });\n *   loader.load();\n */\n\n(function(window) {\n    'use strict';\n\n    // Default configuration\n    const DEFAULTS = {\n        timeout: 10000,           // 10 seconds\n        failsafeTimeout: 15000,   // 15 seconds\n        retryAttempts: 3,\n        retryDelay: 1000,\n        loadingText: 'Loading...',\n        errorText: 'Unable to load',\n        timeoutText: 'Request timed out',\n        unauthText: 'Not logged in',\n        sessionExpiredText: 'Session expired'\n    };\n\n    // States\n    const STATES = {\n        INITIAL: 'initial',\n        LOADING: 'loading',\n        LOADED: 'loaded',\n        ERROR: 'error',\n        TIMEOUT: 'timeout',\n        UNAUTHENTICATED: 'unauthenticated',\n        SESSION_EXPIRED: 'session-expired'\n    };\n\n    /**\n     * Check if user has valid auth token\n     */\n    function hasAuthToken() {\n        const token = localStorage.getItem('access_token');\n        return token && token.length > 0;\n    }\n\n    /**\n     * Get auth headers for API calls\n     */\n    function getAuthHeaders() {\n        const token = localStorage.getItem('access_token');\n        return token ? { 'Authorization': 'Bearer ' + token } : {};\n    }\n\n    /**\n     * DashboardLoader class\n     */\n    class DashboardLoader {\n        constructor(options) {\n            this.options = { ...DEFAULTS, ...options };\n            this.state = STATES.INITIAL;\n            this.abortController = null;\n            this.timeoutId = null;\n            this.failsafeId = null;\n            this.retryCount = 0;\n            \n            // Validate required options\n            if (!this.options.containerId) {\n                throw new Error('DashboardLoader: containerId is required');\n            }\n            if (!this.options.onLoad) {\n                throw new Error('DashboardLoader: onLoad function is required');\n            }\n        }\n\n        /**\n         * Get the container element\n         */\n        getContainer() {\n            return document.getElementById(this.options.containerId);\n        }\n\n        /**\n         * Set the current state\n         */\n        setState(state, data = null) {\n            this.state = state;\n            \n            const container = this.getContainer();\n            if (!container) return;\n\n            // Remove all state classes\n            Object.values(STATES).forEach(s => {\n                container.classList.remove(`loader-state-${s}`);\n            });\n            \n            // Add current state class\n            container.classList.add(`loader-state-${state}`);\n\n            // Call state-specific handler if provided\n            const handler = this.options[`on${state.charAt(0).toUpperCase() + state.slice(1)}`];\n            if (typeof handler === 'function') {\n                handler(data);\n            }\n\n            // Log state change\n            if (window.FrontendLogger) {\n                FrontendLogger.info(`[${this.options.containerId}] State: ${state}`, data);\n            }\n        }\n\n        /**\n         * Show loading state\n         */\n        showLoading() {\n            this.setState(STATES.LOADING);\n            \n            if (this.options.renderLoading) {\n                this.options.renderLoading();\n            }\n        }\n\n        /**\n         * Show error state with retry button\n         */\n        showError(error) {\n            this.setState(STATES.ERROR, { error });\n            \n            if (this.options.renderError) {\n                this.options.renderError(error, () => this.load());\n            }\n        }\n\n        /**\n         * Show timeout state\n         */\n        showTimeout() {\n            this.setState(STATES.TIMEOUT);\n            \n            if (this.options.renderTimeout) {\n                this.options.renderTimeout(() => this.load());\n            }\n        }\n\n        /**\n         * Show unauthenticated state\n         */\n        showUnauthenticated() {\n            this.setState(STATES.UNAUTHENTICATED);\n            \n            if (this.options.renderUnauthenticated) {\n                this.options.renderUnauthenticated();\n            }\n        }\n\n        /**\n         * Show session expired state\n         */\n        showSessionExpired() {\n            this.setState(STATES.SESSION_EXPIRED);\n            \n            if (this.options.renderSessionExpired) {\n                this.options.renderSessionExpired();\n            }\n        }\n\n        /**\n         * Clear all timers\n         */\n        clearTimers() {\n            if (this.timeoutId) {\n                clearTimeout(this.timeoutId);\n                this.timeoutId = null;\n            }\n            if (this.failsafeId) {\n                clearTimeout(this.failsafeId);\n                this.failsafeId = null;\n            }\n        }\n\n        /**\n         * Abort current request\n         */\n        abort() {\n            if (this.abortController) {\n                this.abortController.abort();\n                this.abortController = null;\n            }\n            this.clearTimers();\n        }\n\n        /**\n         * Main load function\n         */\n        async load() {\n            // Abort any previous request\n            this.abort();\n\n            // Check authentication first\n            if (this.options.requiresAuth !== false && !hasAuthToken()) {\n                this.showUnauthenticated();\n                return;\n            }\n\n            // Show loading state\n            this.showLoading();\n\n            // Create abort controller\n            this.abortController = new AbortController();\n\n            // Set timeout\n            this.timeoutId = setTimeout(() => {\n                if (window.FrontendLogger) {\n                    FrontendLogger.warn(`[${this.options.containerId}] Timeout after ${this.options.timeout}ms`);\n                }\n                this.abort();\n                this.showTimeout();\n            }, this.options.timeout);\n\n            // Set failsafe\n            this.failsafeId = setTimeout(() => {\n                if (this.state === STATES.LOADING) {\n                    if (window.FrontendLogger) {\n                        FrontendLogger.error(`[${this.options.containerId}] Failsafe triggered after ${this.options.failsafeTimeout}ms`);\n                    }\n                    this.abort();\n                    this.showTimeout();\n                }\n            }, this.options.failsafeTimeout);\n\n            try {\n                // Execute the load function\n                const result = await this.options.onLoad({\n                    signal: this.abortController.signal,\n                    headers: getAuthHeaders()\n                });\n\n                // Clear timers on success\n                this.clearTimers();\n\n                // Handle 401 specifically\n                if (result && result.status === 401) {\n                    this.showSessionExpired();\n                    return;\n                }\n\n                // Call success handler\n                this.setState(STATES.LOADED, result);\n                \n                if (this.options.onSuccess) {\n                    this.options.onSuccess(result);\n                }\n\n                // Reset retry count on success\n                this.retryCount = 0;\n\n            } catch (error) {\n                this.clearTimers();\n\n                // Ignore abort errors (handled by timeout)\n                if (error.name === 'AbortError') {\n                    return;\n                }\n\n                if (window.FrontendLogger) {\n                    FrontendLogger.error(`[${this.options.containerId}] Load failed`, { error: error.message });\n                }\n\n                // Try cached data if available\n                if (this.options.getCachedData) {\n                    const cached = this.options.getCachedData();\n                    if (cached) {\n                        this.setState(STATES.LOADED, cached);\n                        if (this.options.onSuccess) {\n                            this.options.onSuccess(cached, { fromCache: true });\n                        }\n                        return;\n                    }\n                }\n\n                // Show error\n                this.showError(error);\n\n                // Call error handler\n                if (this.options.onError) {\n                    this.options.onError(error);\n                }\n            }\n        }\n\n        /**\n         * Retry loading\n         */\n        retry() {\n            this.retryCount++;\n            \n            if (this.retryCount <= this.options.retryAttempts) {\n                setTimeout(() => this.load(), this.options.retryDelay);\n            } else {\n                this.showError(new Error('Max retry attempts reached'));\n            }\n        }\n\n        /**\n         * Destroy the loader\n         */\n        destroy() {\n            this.abort();\n            this.state = STATES.INITIAL;\n        }\n    }\n\n    // Export\n    window.DashboardLoader = DashboardLoader;\n    window.DashboardLoaderStates = STATES;\n    window.hasAuthToken = hasAuthToken;\n    window.getAuthHeaders = getAuthHeaders;\n\n})(window);\n"],"names":["window","DEFAULTS","timeout","failsafeTimeout","retryAttempts","retryDelay","loadingText","errorText","timeoutText","unauthText","sessionExpiredText","STATES","INITIAL","LOADING","LOADED","ERROR","TIMEOUT","UNAUTHENTICATED","SESSION_EXPIRED","hasAuthToken","token","localStorage","getItem","length","getAuthHeaders","Authorization","DashboardLoader","constructor","options","this","state","abortController","timeoutId","failsafeId","retryCount","containerId","Error","onLoad","getContainer","document","getElementById","setState","data","container","Object","values","forEach","s","classList","remove","add","handler","charAt","toUpperCase","slice","FrontendLogger","info","showLoading","renderLoading","showError","error","renderError","load","showTimeout","renderTimeout","showUnauthenticated","renderUnauthenticated","showSessionExpired","renderSessionExpired","clearTimers","clearTimeout","abort","requiresAuth","AbortController","setTimeout","warn","result","signal","headers","status","onSuccess","name","message","getCachedData","cached","fromCache","onError","retry","destroy","DashboardLoaderStates"],"mappings":"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"}