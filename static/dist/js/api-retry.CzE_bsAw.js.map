{"version":3,"file":"api-retry.CzE_bsAw.js","sources":["../../js/api-retry.js"],"sourcesContent":["/**\n * API Retry Utility\n * \n * Provides retry logic with exponential backoff for failed API calls.\n * Features:\n * - Configurable retry count (default: 3)\n * - Exponential backoff between retries\n * - Retry button UI component\n * - Integration with FrontendLogger\n * \n * Converted to ES6 module - maintains backward compatibility via window attachment\n */\n\nimport { TIMEOUTS, HTTP_STATUS } from './constants.js';\n\n// Default configuration\nexport const DEFAULT_RETRY_CONFIG = {\n    maxRetries: 3,\n    baseDelay: 1000,\n    maxDelay: TIMEOUTS.API_REQUEST,\n    backoffMultiplier: 2\n};\n\n/**\n * Calculate delay with exponential backoff\n */\nexport function calculateDelay(attempt, config = DEFAULT_RETRY_CONFIG) {\n    const delay = config.baseDelay * Math.pow(config.backoffMultiplier, attempt);\n    return Math.min(delay, config.maxDelay);\n}\n\n/**\n * Sleep for specified milliseconds\n */\nexport function sleep(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Fetch with retry logic\n * @param {string} url - The URL to fetch\n * @param {object} options - Fetch options\n * @param {object} retryConfig - Retry configuration\n * @returns {Promise<Response>} - The fetch response\n */\nexport async function fetchWithRetry(url, options = {}, retryConfig = {}) {\n    const config = { ...DEFAULT_RETRY_CONFIG, ...retryConfig };\n    let lastError;\n\n    for (let attempt = 0; attempt <= config.maxRetries; attempt++) {\n        try {\n            if (attempt > 0) {\n                const delay = calculateDelay(attempt - 1, config);\n                _log('info', `Retry attempt ${attempt}/${config.maxRetries} for ${url}, waiting ${delay}ms`);\n                await sleep(delay);\n            }\n\n            const response = await fetch(url, options);\n\n            // Don't retry on client errors (4xx) except for specific cases\n            if (response.status >= 400 && response.status < 500 &&\n                response.status !== HTTP_STATUS.TIMEOUT &&\n                response.status !== HTTP_STATUS.TOO_MANY_REQUESTS) {\n                return response;\n            }\n\n            // Retry on server errors (5xx) or timeout/rate limit\n            if (response.status >= 500 ||\n                response.status === HTTP_STATUS.TIMEOUT ||\n                response.status === HTTP_STATUS.TOO_MANY_REQUESTS) {\n                lastError = new Error(`HTTP ${response.status}`);\n                if (attempt < config.maxRetries) {\n                    _log('warn', `Request failed with ${response.status}, will retry`, { url, attempt });\n                    continue;\n                }\n                throw lastError; // Final attempt failed\n            }\n\n            return response;\n        } catch (error) {\n            lastError = error;\n            _log('warn', `Request failed: ${error.message}, attempt ${attempt + 1}/${config.maxRetries + 1}`, { url });\n\n            if (attempt >= config.maxRetries) {\n                throw error;\n            }\n        }\n    }\n\n    throw lastError;\n}\n\n/**\n * Create a retry button element\n * @param {function} retryCallback - Function to call when retry is clicked\n * @param {string} message - Error message to display\n * @returns {HTMLElement} - The retry button container\n */\nexport function createRetryButton(retryCallback, message = 'Failed to load data') {\n    const container = document.createElement('div');\n    container.className = 'retry-container';\n    container.style.cssText = 'text-align: center; padding: 20px; color: var(--text-muted);';\n\n    const errorIcon = document.createElement('div');\n    errorIcon.innerHTML = '‚ö†Ô∏è';\n    errorIcon.style.cssText = 'font-size: 32px; margin-bottom: 12px;';\n    errorIcon.setAttribute('aria-hidden', 'true');\n\n    const errorMsg = document.createElement('div');\n    errorMsg.textContent = message;\n    errorMsg.style.cssText = 'margin-bottom: 16px; color: var(--text-secondary);';\n    errorMsg.setAttribute('role', 'alert');\n\n    const retryBtn = document.createElement('button');\n    retryBtn.className = 'btn btn-secondary';\n    retryBtn.innerHTML = 'üîÑ Retry';\n    retryBtn.style.cssText = 'padding: 8px 16px; cursor: pointer;';\n    retryBtn.setAttribute('aria-label', 'Retry loading data');\n    retryBtn.onclick = function () {\n        retryBtn.disabled = true;\n        retryBtn.innerHTML = '<span class=\"loading-spinner\"></span> Retrying...';\n        retryBtn.setAttribute('aria-busy', 'true');\n\n        Promise.resolve(retryCallback()).finally(() => {\n            retryBtn.disabled = false;\n            retryBtn.innerHTML = 'üîÑ Retry';\n            retryBtn.setAttribute('aria-busy', 'false');\n        });\n    };\n\n    container.appendChild(errorIcon);\n    container.appendChild(errorMsg);\n    container.appendChild(retryBtn);\n\n    return container;\n}\n\n/**\n * Show retry UI in a container element\n * @param {HTMLElement|string} container - Container element or selector\n * @param {function} retryCallback - Function to call when retry is clicked\n * @param {string} message - Error message to display\n */\nexport function showRetryUI(container, retryCallback, message) {\n    const el = typeof container === 'string' ? document.querySelector(container) : container;\n    if (!el) return;\n\n    el.innerHTML = '';\n    el.appendChild(createRetryButton(retryCallback, message));\n}\n\n/**\n * Wrapper for API calls with automatic retry and error handling\n * @param {object} options - Configuration options\n */\nexport async function apiCall(options) {\n    const {\n        url,\n        fetchOptions = { credentials: 'include' },\n        container,\n        onSuccess,\n        onError,\n        errorMessage = 'Failed to load data',\n        retryConfig = {}\n    } = options;\n\n    const doFetch = async () => {\n        try {\n            const response = await fetchWithRetry(url, fetchOptions, retryConfig);\n\n            if (!response.ok) {\n                throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n            }\n\n            const data = await response.json();\n\n            if (onSuccess) {\n                onSuccess(data, response);\n            }\n\n            return data;\n        } catch (error) {\n            _log('error', `API call failed after retries: ${url}`, { error: error.message });\n\n            if (container) {\n                showRetryUI(container, doFetch, errorMessage);\n            }\n\n            if (onError) {\n                onError(error);\n            }\n\n            throw error;\n        }\n    };\n\n    return doFetch();\n}\n\n/**\n * Internal logging helper\n */\nfunction _log(level, message, data = null) {\n    if (typeof window !== 'undefined' && window.FrontendLogger) {\n        window.FrontendLogger[level](message, data);\n    } else {\n        const logFn = level === 'error' ? console.error : level === 'warn' ? console.warn : console.log;\n        logFn(`[ApiRetry] ${message}`, data || '');\n    }\n}\n\n// Public API object for backward compatibility\nexport const ApiRetry = {\n    fetchWithRetry,\n    createRetryButton,\n    showRetryUI,\n    apiCall,\n    config: DEFAULT_RETRY_CONFIG\n};\n\n// Attach to window for legacy scripts\nif (typeof window !== 'undefined') {\n    window.ApiRetry = ApiRetry;\n}\n"],"names":["DEFAULT_RETRY_CONFIG","maxRetries","baseDelay","maxDelay","TIMEOUTS","API_REQUEST","backoffMultiplier","calculateDelay","attempt","config","delay","Math","pow","min","sleep","ms","Promise","resolve","setTimeout","async","fetchWithRetry","url","options","retryConfig","lastError","_log","response","fetch","status","HTTP_STATUS","TIMEOUT","TOO_MANY_REQUESTS","Error","error","message","createRetryButton","retryCallback","container","document","createElement","className","style","cssText","errorIcon","innerHTML","setAttribute","errorMsg","textContent","retryBtn","onclick","disabled","finally","appendChild","showRetryUI","el","querySelector","level","data","window","FrontendLogger","console","warn","log","ApiRetry","apiCall","fetchOptions","credentials","onSuccess","onError","errorMessage","doFetch","ok","statusText","json"],"mappings":"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"}