version: '3.8'

services:
  # US East Region
  namaskah-us-east:
    build: .
    environment:
      - REGION=us-east
      - DATABASE_URL=postgresql://user:pass@db-us-east:5432/namaskah
      - REDIS_URL=redis://redis-us-east:6379/0
    ports:
      - "8001:8000"
    depends_on:
      - db-us-east
      - redis-us-east

  db-us-east:
    image: postgres:15
    environment:
      POSTGRES_DB: namaskah
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data_us_east:/var/lib/postgresql/data

  redis-us-east:
    image: redis:7-alpine
    volumes:
      - redis_data_us_east:/data

  # EU West Region
  namaskah-eu-west:
    build: .
    environment:
      - REGION=eu-west
      - DATABASE_URL=postgresql://user:pass@db-eu-west:5432/namaskah
      - REDIS_URL=redis://redis-eu-west:6379/0
    ports:
      - "8002:8000"
    depends_on:
      - db-eu-west
      - redis-eu-west

  db-eu-west:
    image: postgres:15
    environment:
      POSTGRES_DB: namaskah
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data_eu_west:/var/lib/postgresql/data

  redis-eu-west:
    image: redis:7-alpine
    volumes:
      - redis_data_eu_west:/data

  # Load Balancer
  nginx-lb:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-multi-region.conf:/etc/nginx/nginx.conf
    depends_on:
      - namaskah-us-east
      - namaskah-eu-west

volumes:
  postgres_data_us_east:
  redis_data_us_east:
  postgres_data_eu_west:
  redis_data_eu_west: